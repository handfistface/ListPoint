{% extends "base.html" %}

{% block title %}Create List - List Tracker{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Create New List</h1>
    <form method="POST" enctype="multipart/form-data" class="card p-6 rounded-lg space-y-4">
        {{ form.hidden_tag() }}
        
        <div>
            <label class="block mb-2 font-semibold">List Name</label>
            {{ form.name(class="w-full p-2 rounded border", style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);") }}
            {% if form.name.errors %}
                <p class="text-red-500 text-sm mt-1">{{ form.name.errors[0] }}</p>
            {% endif %}
        </div>
        
        <div>
            <label class="block mb-2 font-semibold">Thumbnail Image (optional, max 500KB)</label>
            <input type="file" id="thumbnail-input" name="thumbnail" accept="image/*" class="hidden">
            <button type="button" onclick="document.getElementById('thumbnail-input').click()" class="px-4 py-2 rounded border hover:opacity-70" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);">
                Choose File
            </button>
            <span id="file-name" class="ml-2" style="color: var(--text-secondary);"></span>
        </div>
        
        <div>
            <label class="block mb-2 font-semibold">Tags (comma-separated)</label>
            {{ form.tags(class="w-full p-2 rounded border", placeholder="e.g. work, shopping, travel", style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);") }}
        </div>
        
        <div class="flex items-center space-x-6">
            <label class="flex items-center space-x-2">
                {{ form.is_public(class="w-4 h-4") }}
                <span>Make Public</span>
            </label>
            
            <label class="flex items-center space-x-2">
                {{ form.is_ethereal(class="w-4 h-4") }}
                <span>Ethereal List âœ¨</span>
            </label>
        </div>
        
        <p class="text-sm" style="color: var(--text-secondary);">
            Ethereal lists can be restored to their original state - perfect for reusable templates like packing lists or checklists.
        </p>
        
        <div class="flex space-x-4">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                Create List
            </button>
            <a href="{{ url_for('index') }}" class="flex-1 card py-2 rounded text-center hover:opacity-80">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const thumbnailInput = document.getElementById('thumbnail-input');
    const fileNameSpan = document.getElementById('file-name');
    const maxSize = 500 * 1024; // 500KB in bytes

    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.9;
                    
                    // Start with reasonable max dimensions
                    const maxDimension = 1200;
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = (height / width) * maxDimension;
                            width = maxDimension;
                        } else {
                            width = (width / height) * maxDimension;
                            height = maxDimension;
                        }
                    }
                    
                    function tryCompress() {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob.size <= maxSize || quality <= 0.1) {
                                // Success or can't compress more
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            } else {
                                // Try reducing quality or dimensions
                                if (quality > 0.5) {
                                    quality -= 0.1;
                                } else {
                                    width = Math.floor(width * 0.9);
                                    height = Math.floor(height * 0.9);
                                    quality = 0.8;
                                }
                                tryCompress();
                            }
                        }, 'image/jpeg', quality);
                    }
                    
                    tryCompress();
                };
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        });
    }

    thumbnailInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        
        if (!file) {
            fileNameSpan.textContent = 'No file chosen';
            fileNameSpan.style.color = 'var(--text-secondary)';
            return;
        }

        // Check if it's an image
        if (!file.type.startsWith('image/')) {
            fileNameSpan.textContent = 'Please select an image file';
            fileNameSpan.style.color = '#ef4444';
            thumbnailInput.value = '';
            return;
        }

        const originalSize = file.size;
        
        // Show processing message
        fileNameSpan.textContent = 'Compressing image...';
        fileNameSpan.style.color = '#fbbf24'; // yellow
        
        try {
            let finalFile = file;
            
            // Only compress if needed
            if (file.size > maxSize) {
                finalFile = await compressImage(file);
            }
            
            // Create a new FileList and assign it to the input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(finalFile);
            thumbnailInput.files = dataTransfer.files;
            
            // Show result
            const compressed = finalFile.size < originalSize;
            fileNameSpan.textContent = `${file.name} (${(finalFile.size / 1024).toFixed(0)}KB)${compressed ? ' - compressed' : ''}`;
            fileNameSpan.style.color = '#10b981'; // green
        } catch (error) {
            fileNameSpan.textContent = 'Error processing image';
            fileNameSpan.style.color = '#ef4444';
            thumbnailInput.value = '';
        }
    });
</script>
{% endblock %}
