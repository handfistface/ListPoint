{% extends "base.html" %}

{% block title %}{{ current_list.name }} - List Tracker{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex items-center mb-4">
        <a href="{{ url_for('index') }}" class="text-blue-500 hover:underline">‚Üê Back</a>
    </div>
    
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-3xl font-bold mb-2">
                {{ current_list.name }}
                {% if current_list.is_ethereal %}
                    <span class="text-2xl">‚ú®</span>
                {% endif %}
            </h1>
            {% if current_list.tags %}
                <div class="flex flex-wrap gap-2 mb-2">
                    {% for tag in current_list.tags %}
                        <span class="text-sm px-3 py-1 rounded" style="background-color: var(--border-color); color: var(--text-secondary);">
                            #{{ tag }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
            {% if not is_owner %}
                <p class="text-sm" style="color: var(--text-secondary);">by @{{ current_list.owner_username }}</p>
            {% endif %}
        </div>
        
        <div class="flex items-center space-x-2">
            {% if is_owner %}
                {% if current_list.is_ethereal %}
                    <button onclick="restoreList()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        üîÑ Restore to Original
                    </button>
                {% endif %}
                <a href="{{ url_for('edit_list', list_id=current_list._id) }}" class="card px-4 py-2 rounded hover:opacity-80">
                    Edit
                </a>
                <button onclick="confirmDelete()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    Delete
                </button>
            {% else %}
                <button onclick="toggleFavorite()" id="favorite-btn" class="{% if is_favorited %}bg-yellow-600{% else %}card{% endif %} px-4 py-2 rounded hover:opacity-80">
                    <span id="favorite-icon">{% if is_favorited %}‚≠ê{% else %}‚òÜ{% endif %}</span>
                    <span id="favorite-text">{% if is_favorited %}Favorited{% else %}Favorite{% endif %}</span>
                </button>
            {% endif %}
        </div>
    </div>

    {% if is_owner %}
        <div class="mb-6">
            <div class="relative">
                <input 
                    type="text" 
                    id="item-input" 
                    placeholder="Type to add item..." 
                    class="w-full p-3 rounded border pr-24"
                    style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
                    autocomplete="off"
                >
                <div id="autocomplete" class="absolute z-10 w-full mt-1 card rounded shadow-lg hidden max-h-48 overflow-y-auto"></div>
                <button id="undo-btn" onclick="undoDelete()" class="absolute right-2 top-2 px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 hidden">
                    ‚Ü∂ Undo (<span id="undo-count">0</span>)
                </button>
            </div>
        </div>
    {% endif %}

    <div class="card p-6 rounded-lg">
        <div id="items-list" class="space-y-2">
            {% if current_list['items'] %}
                {% for item in current_list['items'] %}
                    <div class="flex items-center justify-between p-3 rounded hover:bg-opacity-50" style="background-color: var(--bg-primary);" data-item-id="{{ item._id }}">
                        <span>{{ item.text }}</span>
                        {% if is_owner %}
                            <button onclick="deleteItem('{{ item._id }}', '{{ item.text }}')" class="text-red-500 hover:text-red-700">
                                √ó
                            </button>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center py-8" style="color: var(--text-secondary);">
                    No items yet. {% if is_owner %}Start adding items above!{% endif %}
                </p>
            {% endif %}
        </div>
    </div>
</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 rounded-lg max-w-md mx-4 fade-in">
        <div id="modal-content" class="text-center"></div>
    </div>
</div>

<form id="delete-form" method="POST" action="{{ url_for('delete_list', list_id=current_list._id) }}" class="hidden">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

{% endblock %}

{% block extra_js %}
<script>
const listId = '{{ current_list._id }}';
const csrfToken = '{{ csrf_token() }}';
const isOwner = {{ 'true' if is_owner else 'false' }};
let undoStack = [];
const MAX_UNDO = 10;

{% if is_owner %}
const itemInput = document.getElementById('item-input');
const autocomplete = document.getElementById('autocomplete');

itemInput.addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        autocomplete.classList.add('hidden');
        return;
    }
    
    const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    
    if (suggestions.length > 0) {
        autocomplete.innerHTML = suggestions.map(s => 
            `<div class="p-2 hover:bg-opacity-80 cursor-pointer" style="background-color: var(--bg-primary);" onclick="selectSuggestion('${s}')">${s}</div>`
        ).join('');
        autocomplete.classList.remove('hidden');
    } else {
        autocomplete.classList.add('hidden');
    }
});

itemInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addItem();
    }
});

document.addEventListener('click', (e) => {
    if (!autocomplete.contains(e.target) && e.target !== itemInput) {
        autocomplete.classList.add('hidden');
    }
});

function selectSuggestion(text) {
    itemInput.value = text;
    autocomplete.classList.add('hidden');
    addItem();
}

async function addItem() {
    const text = itemInput.value.trim();
    if (!text) return;
    
    const response = await fetch(`/api/lists/${listId}/items`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item added successfully', 'success');
        itemInput.value = '';
        setTimeout(() => location.reload(), 1000);
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
}

async function deleteItem(itemId, itemText) {
    const response = await fetch(`/api/lists/${listId}/items/${itemId}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    if (response.ok) {
        undoStack.push({ id: itemId, text: itemText });
        if (undoStack.length > MAX_UNDO) {
            undoStack.shift();
        }
        updateUndoButton();
        
        document.querySelector(`[data-item-id="${itemId}"]`).remove();
        
        if (document.querySelectorAll('[data-item-id]').length === 0) {
            document.getElementById('items-list').innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary);">No items yet. Start adding items above!</p>';
        }
    }
}

function updateUndoButton() {
    const undoBtn = document.getElementById('undo-btn');
    const undoCount = document.getElementById('undo-count');
    
    if (undoStack.length > 0) {
        undoBtn.classList.remove('hidden');
        undoCount.textContent = undoStack.length;
    } else {
        undoBtn.classList.add('hidden');
    }
}

async function undoDelete() {
    if (undoStack.length === 0) return;
    
    const item = undoStack.pop();
    updateUndoButton();
    
    const response = await fetch(`/api/lists/${listId}/items`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text: item.text })
    });
    
    if (response.ok) {
        location.reload();
    }
}

async function restoreList() {
    if (!confirm('Restore list to original items? Current items will be replaced.')) {
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/restore`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì List restored successfully', 'success');
        setTimeout(() => location.reload(), 1000);
    } else {
        showModal('‚úó Failed to restore list', 'error');
    }
}
{% endif %}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this list? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}

{% if not is_owner %}
async function toggleFavorite() {
    const response = await fetch(`/api/favorite/${listId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    const result = await response.json();
    
    if (result.success) {
        const btn = document.getElementById('favorite-btn');
        const icon = document.getElementById('favorite-icon');
        const text = document.getElementById('favorite-text');
        
        if (result.favorited) {
            btn.classList.remove('card');
            btn.classList.add('bg-yellow-600');
            icon.textContent = '‚≠ê';
            text.textContent = 'Favorited';
        } else {
            btn.classList.add('card');
            btn.classList.remove('bg-yellow-600');
            icon.textContent = '‚òÜ';
            text.textContent = 'Favorite';
        }
    }
}
{% endif %}

function showModal(message, type) {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    content.innerHTML = `<div class="${bgColor} text-white p-4 rounded">${message}</div>`;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    const duration = type === 'success' ? 2000 : 3000;
    setTimeout(() => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }, duration);
}
</script>
{% endblock %}
