{% extends "base.html" %}

{% block title %}{{ current_list.name }} - List Point{% endblock %}
{% block description %}View and manage {{ current_list.name }} on List Point. {% if current_list.tags %}Tags: {{ current_list.tags|join(', ') }}.{% endif %} {% if current_list.is_ethereal %}Check list with restore functionality.{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .section-item-odd {
        background-color: var(--bg-primary);
    }
    .section-item-even {
        background-color: var(--bg-primary);
    }
    .section-header {
        border-bottom: 2px solid var(--border-color);
        transition: background-color 0.2s ease;
    }
    .section-header:hover {
        background-color: rgba(59, 130, 246, 0.3) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    {% if not current_user.is_authenticated or not current_user.subscription.get('is_ad_free', False) %}
    <div class="ad-container mb-4" style="display:none;min-height:0;overflow:hidden;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="{{ adsense_publisher_id }}"
             data-ad-slot="9050273015"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    {% endif %}
    
    {% if current_list.thumbnail_url %}
    <div class="mb-6">
        <img src="{{ current_list.thumbnail_url }}" alt="{{ current_list.name }}" class="w-full max-w-md h-48 object-cover rounded-lg">
    </div>
    {% endif %}
    
    {% if parent_list or clone_count > 0 %}
    <div class="mb-4 flex gap-3 items-center">
        {% if parent_list %}
        <a href="{{ url_for('view_list', list_id=parent_list._id|string) }}" class="text-sm px-3 py-1 rounded card hover:opacity-80">
            ‚Üë parent
        </a>
        {% endif %}
        {% if clone_count > 0 %}
        <button onclick="showChildrenModal()" class="text-sm px-3 py-1 rounded card hover:opacity-80">
            Children {{ clone_count }}
        </button>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="mb-6">
        <div class="flex items-start gap-3 mb-2">
            <h1 class="text-3xl font-bold flex-1">
                {{ current_list.name }}
                {% if current_list.is_ethereal %}
                    <span class="text-2xl">‚úì</span>
                {% endif %}
            </h1>
            
            <div class="relative" id="list-menu-container">
                <button onclick="toggleListMenu()" class="p-2 rounded card hover:opacity-80" id="list-menu-btn" aria-label="List actions menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                
                <div id="list-menu-dropdown" class="absolute right-0 mt-2 w-48 rounded-lg shadow-lg card hidden z-50">
                    <div class="py-1">
                        {% if is_owner %}
                        <a href="{{ url_for('edit_list', list_id=current_list._id) }}" class="block px-4 py-2 hover:opacity-80 transition-colors" style="color: var(--text-primary);">
                            ‚úèÔ∏è Edit List
                        </a>
                        <button onclick="confirmDelete()" class="w-full text-left px-4 py-2 hover:opacity-80 transition-colors text-red-500">
                            üóëÔ∏è Delete
                        </button>
                        {% endif %}
                        {% if current_user.is_authenticated %}
                        <button onclick="cloneList()" class="w-full text-left px-4 py-2 hover:opacity-80 transition-colors" style="color: var(--text-primary);">
                            üìã Clone
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        {% if current_list.tags %}
            <div class="flex flex-wrap gap-2 mb-2">
                {% for tag in current_list.tags %}
                    <span class="text-sm px-3 py-1 rounded" style="background-color: var(--border-color); color: var(--text-secondary);">
                        #{{ tag }}
                    </span>
                {% endfor %}
            </div>
        {% endif %}
        {% if not is_owner %}
            <p class="text-sm" style="color: var(--text-secondary);">by @{{ current_list.owner_username }}</p>
        {% endif %}
        
        <div class="flex items-center space-x-2 flex-wrap gap-2 mt-4">
            {% if is_owner %}
                {% if current_list.is_ethereal %}
                    <button id="mode-toggle-btn" onclick="toggleMode()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        <span id="mode-toggle-text">üìù Edit Mode</span>
                    </button>
                    <button id="restore-btn" onclick="restoreList()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        <span id="restore-text">üîÑ Uncheck All</span>
                    </button>
                {% endif %}
            {% else %}
                <button onclick="toggleFavorite()" id="favorite-btn" class="{% if is_favorited %}bg-yellow-600{% else %}card{% endif %} px-4 py-2 rounded hover:opacity-80">
                    <span id="favorite-icon">{% if is_favorited %}‚≠ê{% else %}‚òÜ{% endif %}</span>
                    <span id="favorite-text">{% if is_favorited %}Favorited{% else %}Favorite{% endif %}</span>
                </button>
            {% endif %}
        </div>
    </div>

    {% if is_owner or is_collaborator %}
        <div class="mb-6 relative" id="add-item-section">
            <div id="autocomplete" class="w-full card rounded shadow-lg hidden max-h-48 overflow-y-auto mb-2" style="position: relative; z-index: 1;"></div>
            <div class="relative">
                <textarea 
                    id="item-input" 
                    placeholder="Type to add item..." 
                    class="w-full p-3 rounded border pr-44 resize-none overflow-hidden"
                    style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary); min-height: 48px;"
                    autocomplete="off"
                    rows="1"
                ></textarea>
                <div class="absolute right-2 top-2 flex gap-2">
                    <button id="add-item-btn" onclick="addItem()" class="px-4 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                        Add
                    </button>
                    <button id="undo-btn" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 hidden" style="user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
                        ‚Ü∂ Undo (<span id="undo-count">0</span>)
                    </button>
                </div>
            </div>
            <div id="inline-notification" class="absolute w-full hidden p-3 rounded text-white text-center" style="top: 100%; margin-top: 8px; z-index: 50;"></div>
        </div>
    {% endif %}

    <div class="card p-6 rounded-lg">
        <div id="items-list">
            {% if current_list['items'] %}
                {% set sections = {} %}
                {% set loose_items = [] %}
                {% for item in current_list['items'] %}
                    {% if item.get('section') %}
                        {% if item.section not in sections %}
                            {% set _ = sections.update({item.section: []}) %}
                        {% endif %}
                        {% set _ = sections[item.section].append(item) %}
                    {% else %}
                        {% set _ = loose_items.append(item) %}
                    {% endif %}
                {% endfor %}
                
                {% for section_name in sections.keys()|sort %}
                    <div class="section-group mb-4" data-section-name="{{ section_name }}">
                        <div class="section-header flex items-center justify-between p-3 rounded-t font-semibold cursor-pointer" style="background-color: var(--bg-secondary); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-section-name="{{ section_name }}">
                            <span>{{ section_name }}</span>
                            {% if is_owner or is_collaborator %}
                                <button onclick="showSectionAddModal('{{ section_name }}', event)" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    ‚ûï
                                </button>
                            {% endif %}
                        </div>
                        <div class="section-items space-y-2 pt-2">
                            {% for item in sections[section_name] %}
                                <div class="flex items-center justify-between p-3 rounded item-row {% if item.get('checked') %}opacity-50{% endif %} {% if loop.index % 2 == 0 %}section-item-even{% else %}section-item-odd{% endif %}" style="cursor: pointer; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-item-id="{{ item._id }}" data-item-text="{{ item.text }}" data-checked="{{ 'true' if item.get('checked') else 'false' }}" data-quantity="{{ item.get('quantity', 1) }}" data-section="{{ item.section }}" onclick="deleteItemByRow('{{ item._id }}', event)">
                                    <div class="flex items-center gap-3 flex-1">
                                        <input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer {% if not current_list.is_ethereal %}hidden{% endif %}" 
                                               onchange="toggleItemChecked('{{ item._id }}')" 
                                               {% if item.get('checked') %}checked{% endif %}
                                               onclick="event.stopPropagation()">
                                        {% if current_list.get('is_ordered') and current_list.get('show_numbering') %}
                                        <span class="item-number font-semibold" style="color: var(--text-secondary); min-width: 2em;">{{ loop.index }}.</span>
                                        {% endif %}
                                        <span class="item-text {% if item.get('checked') %}line-through{% endif %}">{{ item.text }}</span>
                                        {% if item.get('quantity', 1) > 1 %}
                                            <span class="text-sm" style="color: var(--text-secondary);">x{{ item.get('quantity', 1) }}</span>
                                        {% endif %}
                                    </div>
                                    {% if is_owner or is_collaborator %}
                                        <div class="flex items-center gap-2">
                                            <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} {% if item.get('quantity', 1) <= 1 %}invisible{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', -1, event)" data-action="decrease">
                                                ‚àí
                                            </button>
                                            <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', 1, event)" data-action="increase">
                                                +
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                
                {% for empty_section in current_list.get('empty_sections', []) %}
                    {% if empty_section not in sections %}
                    <div class="section-group mb-4" data-section-name="{{ empty_section }}">
                        <div class="section-header flex items-center justify-between p-3 rounded-t font-semibold cursor-pointer" style="background-color: var(--bg-secondary); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-section-name="{{ empty_section }}">
                            <span>{{ empty_section }}</span>
                            {% if is_owner or is_collaborator %}
                                <button onclick="showSectionAddModal('{{ empty_section }}', event)" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    ‚ûï
                                </button>
                            {% endif %}
                        </div>
                        <div class="section-items space-y-2 pt-2">
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
                
                {% if loose_items %}
                    <div class="loose-items-separator border-t-2 mt-6 pt-4" style="border-color: var(--border-color);">
                        <div class="space-y-2">
                            {% for item in loose_items %}
                                <div class="flex items-center justify-between p-3 rounded item-row {% if item.get('checked') %}opacity-50{% endif %}" style="background-color: var(--bg-primary); cursor: pointer; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-item-id="{{ item._id }}" data-item-text="{{ item.text }}" data-checked="{{ 'true' if item.get('checked') else 'false' }}" data-quantity="{{ item.get('quantity', 1) }}" onclick="deleteItemByRow('{{ item._id }}', event)">
                                    <div class="flex items-center gap-3 flex-1">
                                        <input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer {% if not current_list.is_ethereal %}hidden{% endif %}" 
                                               onchange="toggleItemChecked('{{ item._id }}')" 
                                               {% if item.get('checked') %}checked{% endif %}
                                               onclick="event.stopPropagation()">
                                        {% if current_list.get('is_ordered') and current_list.get('show_numbering') %}
                                        <span class="item-number font-semibold" style="color: var(--text-secondary); min-width: 2em;">{{ loop.index }}.</span>
                                        {% endif %}
                                        <span class="item-text {% if item.get('checked') %}line-through{% endif %}">{{ item.text }}</span>
                                        {% if item.get('quantity', 1) > 1 %}
                                            <span class="text-sm" style="color: var(--text-secondary);">x{{ item.get('quantity', 1) }}</span>
                                        {% endif %}
                                    </div>
                                    {% if is_owner or is_collaborator %}
                                        <div class="flex items-center gap-2">
                                            <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} {% if item.get('quantity', 1) <= 1 %}invisible{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', -1, event)" data-action="decrease">
                                                ‚àí
                                            </button>
                                            <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', 1, event)" data-action="increase">
                                                +
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                <p class="text-center py-8" style="color: var(--text-secondary);">
                    No items yet. {% if is_owner or is_collaborator %}Start adding items above!{% endif %}
                </p>
            {% endif %}
        </div>
    </div>
</div>

<div id="context-menu" class="fixed hidden card rounded-lg shadow-lg z-50" style="min-width: 160px;">
    <div class="py-1" id="item-context-menu">
        <button 
            onclick="copyItemText()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            üìã Copy Text
        </button>
        <button 
            onclick="editItemFromMenu()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            ‚úèÔ∏è Edit Item
        </button>
        {% if is_owner or is_collaborator %}
        <button 
            onclick="createSectionFromItem()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            üìÅ Create Section
        </button>
        <button 
            onclick="promoteToSection()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            ‚¨ÜÔ∏è Promote to Section
        </button>
        {% if current_list.is_ordered %}
        <button 
            id="enter-move-mode-btn-menu"
            onclick="enterMoveMode()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            ‚ÜïÔ∏è Move
        </button>
        {% endif %}
        {% endif %}
    </div>
    <div class="py-1 hidden" id="section-context-menu">
        {% if is_owner or is_collaborator %}
        <button 
            onclick="renameSectionFromMenu()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors"
            style="color: var(--text-primary);"
        >
            ‚úèÔ∏è Rename Section
        </button>
        <button 
            onclick="deleteSectionFromMenu()" 
            class="w-full text-left px-4 py-2 hover:bg-opacity-80 transition-colors text-red-500"
        >
            üóëÔ∏è Delete Section
        </button>
        {% endif %}
    </div>
</div>

<div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeEditModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Edit Item</h3>
        <input 
            type="text" 
            id="edit-item-input" 
            class="w-full p-3 rounded border mb-4"
            style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="Enter item text..."
        >
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeEditModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="saveEditedItem()" 
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
            >
                Save
            </button>
        </div>
    </div>
</div>

<div id="undo-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeUndoModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in max-h-96" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-2">‚Ü∂ Removed Items</h3>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">Click on any item to add items back to the list</p>
        <div id="undo-modal-list" class="space-y-2 overflow-y-auto max-h-64 mb-4">
        </div>
        <div class="flex justify-end">
            <button 
                onclick="closeUndoModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Close
            </button>
        </div>
    </div>
</div>

<div id="children-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeChildrenModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in max-h-96" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Cloned Lists</h3>
        <div id="children-list" class="space-y-2 overflow-y-auto max-h-64 mb-4">
        </div>
        <div class="flex justify-end">
            <button 
                onclick="closeChildrenModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Close
            </button>
        </div>
    </div>
</div>

<form id="delete-form" method="POST" action="{{ url_for('delete_list', list_id=current_list._id) }}" class="hidden">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<form id="clone-form" method="POST" action="{{ url_for('clone_list', list_id=current_list._id) }}" class="hidden">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

<div id="create-section-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeCreateSectionModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Create Section</h3>
        <div id="section-autocomplete" class="w-full card rounded shadow-lg hidden max-h-48 overflow-y-auto mb-2"></div>
        <input 
            type="text" 
            id="section-name-input" 
            class="w-full p-3 rounded border mb-4"
            style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="Enter section name..."
        >
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeCreateSectionModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="saveNewSection()" 
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
            >
                Create
            </button>
        </div>
    </div>
</div>

<div id="rename-section-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeRenameSectionModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Rename Section</h3>
        <input 
            type="text" 
            id="rename-section-input" 
            class="w-full p-3 rounded border mb-4"
            style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="Enter new section name..."
        >
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeRenameSectionModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="saveRenamedSection()" 
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
            >
                Save
            </button>
        </div>
    </div>
</div>

<div id="delete-section-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeDeleteSectionModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Delete Section</h3>
        <p class="mb-4" style="color: var(--text-secondary);">Are you sure you want to delete this section and all items within it? This action cannot be undone.</p>
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeDeleteSectionModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="confirmDeleteSection()" 
                class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
            >
                Delete
            </button>
        </div>
    </div>
</div>

<div id="move-to-section-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeMoveToSectionModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Move Item to Section</h3>
        <p class="text-sm mb-4" style="color: var(--text-secondary);">Select a section to move "<span id="move-item-name"></span>" to:</p>
        <div id="section-list" class="space-y-2 overflow-y-auto max-h-64 mb-4">
        </div>
        <div class="flex justify-end">
            <button 
                onclick="closeMoveToSectionModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
        </div>
    </div>
</div>

<div id="section-add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeSectionAddModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Add Item to <span id="section-add-title"></span></h3>
        <div id="section-autocomplete" class="w-full card rounded shadow-lg hidden max-h-48 overflow-y-auto mb-2" style="position: relative; z-index: 1;"></div>
        <input 
            type="text" 
            id="section-item-input" 
            class="w-full p-3 rounded border mb-4"
            style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="Enter item text..."
        >
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeSectionAddModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="addItemToSection()" 
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
            >
                Add
            </button>
        </div>
    </div>
</div>

<div id="exit-move-mode-btn" class="fixed hidden z-50" style="top: 20px; left: 50%; transform: translateX(-50%);">
    <button 
        onclick="exitMoveMode()" 
        class="px-6 py-3 rounded-lg shadow-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors"
        style="font-size: 16px;"
    >
        ‚úï Exit Move Mode
    </button>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Updated: Oct 15, 2025 - Fixed touch event handlers
const listId = '{{ current_list._id }}';
const csrfToken = '{{ csrf_token() }}';
const isOwner = {{ 'true' if is_owner else 'false' }};
const isCollaborator = {{ 'true' if is_collaborator else 'false' }};
const isEthereal = {{ 'true' if current_list.is_ethereal else 'false' }};
const isOrdered = {{ 'true' if current_list.is_ordered else 'false' }};
const showNumbering = {{ 'true' if current_list.get('show_numbering') else 'false' }};
let undoStack = [];
const MAX_UNDO = 10;
let currentMode = 'checkOff';

let moveModeActive = false;
let draggedItem = null;
let draggedItemElement = null;
let dragPlaceholder = null;
let touchStartY = 0;
let touchCurrentY = 0;
let touchTargetElement = null;
let autoScrollInterval = null;

function loadUndoStack() {
    const storageKey = `undoStack_${listId}`;
    const stored = localStorage.getItem(storageKey);
    if (stored) {
        try {
            undoStack = JSON.parse(stored);
            updateUndoButton();
        } catch (e) {
            console.error('Failed to load undo stack:', e);
            undoStack = [];
        }
    }
}

function saveUndoStack() {
    const storageKey = `undoStack_${listId}`;
    try {
        localStorage.setItem(storageKey, JSON.stringify(undoStack));
    } catch (e) {
        console.error('Failed to save undo stack:', e);
    }
}

loadUndoStack();

function toggleMode() {
    if (!isEthereal || !isOwner) return;
    
    currentMode = currentMode === 'checkOff' ? 'edit' : 'checkOff';
    updateUIForMode();
}

function updateUIForMode() {
    const modeToggleText = document.getElementById('mode-toggle-text');
    const restoreText = document.getElementById('restore-text');
    const addItemSection = document.getElementById('add-item-section');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const deleteButtons = document.querySelectorAll('.item-delete-btn');
    
    if (currentMode === 'edit') {
        if (modeToggleText) modeToggleText.textContent = '‚òë Check Off Mode';
        if (restoreText) restoreText.textContent = 'üîÑ Restore to Original';
        if (addItemSection) addItemSection.style.display = 'block';
        checkboxes.forEach(cb => cb.classList.add('hidden'));
        deleteButtons.forEach(btn => btn.classList.remove('hidden'));
    } else {
        if (modeToggleText) modeToggleText.textContent = 'üìù Edit Mode';
        if (restoreText) restoreText.textContent = 'üîÑ Uncheck All';
        if (addItemSection) addItemSection.style.display = 'none';
        checkboxes.forEach(cb => cb.classList.remove('hidden'));
        deleteButtons.forEach(btn => btn.classList.add('hidden'));
    }
}

async function toggleItemChecked(itemId) {
    const response = await fetch(`/api/lists/${listId}/items/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    if (response.ok) {
        const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
        const checkbox = itemRow.querySelector('.item-checkbox');
        const itemText = itemRow.querySelector('.item-text');
        const isChecked = checkbox.checked;
        
        if (isChecked) {
            itemText.classList.add('line-through');
            itemRow.classList.add('opacity-50');
        } else {
            itemText.classList.remove('line-through');
            itemRow.classList.remove('opacity-50');
        }
    }
}

if (isEthereal && isOwner) {
    updateUIForMode();
}

{% if is_owner or is_collaborator %}
const itemInput = document.getElementById('item-input');
const autocomplete = document.getElementById('autocomplete');

function autoResizeTextarea() {
    itemInput.style.height = 'auto';
    itemInput.style.height = itemInput.scrollHeight + 'px';
}

itemInput.addEventListener('input', async (e) => {
    autoResizeTextarea();
    
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        autocomplete.classList.add('hidden');
        return;
    }
    
    const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    
    if (suggestions.length > 0) {
        autocomplete.innerHTML = suggestions.map(s => 
            `<div class="p-2 hover:bg-opacity-80 cursor-pointer" style="background-color: var(--bg-primary);" onclick="selectSuggestion('${s}')">${s}</div>`
        ).join('');
        autocomplete.classList.remove('hidden');
    } else {
        autocomplete.classList.add('hidden');
    }
});

itemInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addItem();
    }
});

document.addEventListener('click', (e) => {
    if (!autocomplete.contains(e.target) && e.target !== itemInput) {
        autocomplete.classList.add('hidden');
    }
});

function selectSuggestion(text) {
    itemInput.value = text;
    autoResizeTextarea();
    autocomplete.classList.add('hidden');
    addItem();
}

let longPressTimer = null;
let longPressTriggered = false;
let contextMenuItemId = null;
let contextMenuItemText = null;

let contextMenuSectionName = null;
let createSectionItemId = null;

let eventListenersSetup = false;

function setupItemEventListeners() {
    if (eventListenersSetup) {
        return;
    }
    eventListenersSetup = true;
    
    const itemsList = document.getElementById('items-list');
    
    itemsList.addEventListener('contextmenu', (e) => {
        const sectionHeader = e.target.closest('.section-header');
        const itemRow = e.target.closest('.item-row');
        
        if (sectionHeader && (isOwner || isCollaborator)) {
            e.preventDefault();
            const sectionName = sectionHeader.getAttribute('data-section-name');
            showSectionContextMenu(e.clientX, e.clientY, sectionName);
        } else if (itemRow) {
            e.preventDefault();
            const itemId = itemRow.getAttribute('data-item-id');
            const currentText = itemRow.getAttribute('data-item-text');
            showContextMenu(e.clientX, e.clientY, itemId, currentText);
        }
    });
    
    itemsList.addEventListener('touchstart', (e) => {
        const sectionHeader = e.target.closest('.section-header');
        const itemRow = e.target.closest('.item-row');
        
        if (sectionHeader && (isOwner || isCollaborator)) {
            longPressTriggered = false;
            const sectionName = sectionHeader.getAttribute('data-section-name');
            
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                navigator.vibrate && navigator.vibrate(50);
                const touch = e.touches[0];
                showSectionContextMenu(touch.clientX, touch.clientY, sectionName);
            }, 500);
        } else if (itemRow) {
            longPressTriggered = false;
            const itemId = itemRow.getAttribute('data-item-id');
            const currentText = itemRow.getAttribute('data-item-text');
            
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                navigator.vibrate && navigator.vibrate(50);
                const touch = e.touches[0];
                showContextMenu(touch.clientX, touch.clientY, itemId, currentText);
            }, 500);
        }
    }, { passive: true });
    
    itemsList.addEventListener('touchend', (e) => {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        
        if (longPressTriggered) {
            e.preventDefault();
            e.stopPropagation();
        }
    }, { passive: false });
    
    itemsList.addEventListener('touchmove', (e) => {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }, { passive: true });
    
    itemsList.addEventListener('click', (e) => {
        if (longPressTriggered) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            setTimeout(() => {
                longPressTriggered = false;
            }, 100);
            return false;
        }
    }, { capture: true });
}

function showContextMenu(x, y, itemId, itemText) {
    contextMenuItemId = itemId;
    contextMenuItemText = itemText;
    contextMenuSectionName = null;
    
    const itemContextMenu = document.getElementById('item-context-menu');
    const sectionContextMenu = document.getElementById('section-context-menu');
    itemContextMenu.classList.remove('hidden');
    sectionContextMenu.classList.add('hidden');
    
    const moveToSectionBtn = document.getElementById('move-to-section-btn');
    if (moveToSectionBtn) {
        const sectionHeaders = document.querySelectorAll('.section-header');
        if (sectionHeaders.length > 0) {
            moveToSectionBtn.classList.remove('hidden');
        } else {
            moveToSectionBtn.classList.add('hidden');
        }
    }
    
    const enterMoveModeBtn = document.getElementById('enter-move-mode-btn-menu');
    if (enterMoveModeBtn) {
        if (moveModeActive) {
            enterMoveModeBtn.classList.add('hidden');
        } else {
            enterMoveModeBtn.classList.remove('hidden');
        }
    }
    
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.remove('hidden');
    
    // Position menu temporarily to get its dimensions
    contextMenu.style.left = `${x}px`;
    contextMenu.style.top = `${y}px`;
    
    const menuRect = contextMenu.getBoundingClientRect();
    
    // Position menu above the click point with 10px gap
    let menuTop = y - menuRect.height - 10;
    let menuLeft = x;
    
    // Adjust if menu goes off the left edge
    if (menuLeft < 10) {
        menuLeft = 10;
    }
    
    // Adjust if menu goes off the right edge
    if (menuLeft + menuRect.width > window.innerWidth - 10) {
        menuLeft = window.innerWidth - menuRect.width - 10;
    }
    
    // If menu goes above viewport, position it below the click point instead
    if (menuTop < 10) {
        menuTop = y + 10;
    }
    
    contextMenu.style.left = `${menuLeft}px`;
    contextMenu.style.top = `${menuTop}px`;
}

function showSectionContextMenu(x, y, sectionName) {
    contextMenuSectionName = sectionName;
    contextMenuItemId = null;
    contextMenuItemText = null;
    
    const itemContextMenu = document.getElementById('item-context-menu');
    const sectionContextMenu = document.getElementById('section-context-menu');
    itemContextMenu.classList.add('hidden');
    sectionContextMenu.classList.remove('hidden');
    
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.remove('hidden');
    
    // Position menu temporarily to get its dimensions
    contextMenu.style.left = `${x}px`;
    contextMenu.style.top = `${y}px`;
    
    const menuRect = contextMenu.getBoundingClientRect();
    
    // Position menu above the click point with 10px gap
    let menuTop = y - menuRect.height - 10;
    let menuLeft = x;
    
    // Adjust if menu goes off the left edge
    if (menuLeft < 10) {
        menuLeft = 10;
    }
    
    // Adjust if menu goes off the right edge
    if (menuLeft + menuRect.width > window.innerWidth - 10) {
        menuLeft = window.innerWidth - menuRect.width - 10;
    }
    
    // If menu goes above viewport, position it below the click point instead
    if (menuTop < 10) {
        menuTop = y + 10;
    }
    
    contextMenu.style.left = `${menuLeft}px`;
    contextMenu.style.top = `${menuTop}px`;
}

function hideContextMenu() {
    const contextMenu = document.getElementById('context-menu');
    contextMenu.classList.add('hidden');
    contextMenuItemId = null;
    contextMenuItemText = null;
    contextMenuSectionName = null;
    longPressTriggered = false;
}

function copyItemText() {
    if (!contextMenuItemText) return;
    
    navigator.clipboard.writeText(contextMenuItemText).then(() => {
        showModal('‚úì Text copied to clipboard', 'success');
    }).catch(err => {
        const textArea = document.createElement('textarea');
        textArea.value = contextMenuItemText;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showModal('‚úì Text copied to clipboard', 'success');
        } catch (err) {
            showModal('‚úó Failed to copy text', 'error');
        }
        document.body.removeChild(textArea);
    });
    
    hideContextMenu();
}

function editItemFromMenu() {
    if (!contextMenuItemId || !contextMenuItemText) return;
    const itemId = contextMenuItemId;
    const itemText = contextMenuItemText;
    hideContextMenu();
    editItem(itemId, itemText);
}

document.addEventListener('click', (e) => {
    const contextMenu = document.getElementById('context-menu');
    if (!contextMenu.contains(e.target)) {
        hideContextMenu();
    }
});

let editingItemId = null;
let editingItemText = null;

function editItem(itemId, currentText) {
    editingItemId = itemId;
    editingItemText = currentText;
    
    const modal = document.getElementById('edit-item-modal');
    const input = document.getElementById('edit-item-input');
    
    input.value = currentText;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeEditModal(event) {
    if (event && event.target.id !== 'edit-item-modal') {
        return;
    }
    
    const modal = document.getElementById('edit-item-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    editingItemId = null;
    editingItemText = null;
}

async function saveEditedItem() {
    const input = document.getElementById('edit-item-input');
    const newText = input.value.trim();
    
    if (!newText || newText === editingItemText) {
        closeEditModal();
        return;
    }
    
    const endpoint = (isEthereal && currentMode === 'edit')
        ? `/api/lists/${listId}/original/items/${editingItemId}`
        : `/api/lists/${listId}/items/${editingItemId}`;
    
    const response = await fetch(endpoint, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text: newText })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item updated successfully', 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
        }
        
        closeEditModal();
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
}

document.getElementById('edit-item-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveEditedItem();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const editModal = document.getElementById('edit-item-modal');
        const undoModal = document.getElementById('undo-modal');
        
        if (!editModal.classList.contains('hidden')) {
            closeEditModal();
        } else if (!undoModal.classList.contains('hidden')) {
            closeUndoModal();
        }
    }
});

{% if is_owner or is_collaborator %}
let undoButtonLongPressTimer = null;
let undoButtonLongPressTriggered = false;

const undoBtn = document.getElementById('undo-btn');

undoBtn.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    showUndoModal();
});

undoBtn.addEventListener('touchstart', (e) => {
    undoButtonLongPressTriggered = false;
    
    undoButtonLongPressTimer = setTimeout(() => {
        undoButtonLongPressTriggered = true;
        navigator.vibrate && navigator.vibrate(50);
        showUndoModal();
    }, 500);
}, { passive: true });

undoBtn.addEventListener('touchend', (e) => {
    if (undoButtonLongPressTimer) {
        clearTimeout(undoButtonLongPressTimer);
        undoButtonLongPressTimer = null;
    }
    
    if (undoButtonLongPressTriggered) {
        e.preventDefault();
        undoButtonLongPressTriggered = false;
    }
}, { passive: false });

undoBtn.addEventListener('touchmove', (e) => {
    if (undoButtonLongPressTimer) {
        clearTimeout(undoButtonLongPressTimer);
        undoButtonLongPressTimer = null;
    }
}, { passive: true });

undoBtn.addEventListener('click', (e) => {
    if (!undoButtonLongPressTriggered) {
        undoDelete();
    }
    undoButtonLongPressTriggered = false;
});
{% endif %}

setupItemEventListeners();

async function addItem() {
    const text = itemInput.value.trim();
    if (!text) return;
    
    const addBtn = document.getElementById('add-item-btn');
    const originalBtnText = addBtn.textContent;
    
    try {
        addBtn.disabled = true;
        addBtn.textContent = '...';
        addBtn.style.opacity = '0.6';
        
        itemInput.value = '';
        autoResizeTextarea();
        
        const endpoint = (isEthereal && currentMode === 'edit') 
            ? `/api/lists/${listId}/original/items`
            : `/api/lists/${listId}/items`;
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ text })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showModal('‚úì Item added', 'success');
            
            const itemsArray = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const itemId = row.getAttribute('data-item-id');
                const itemText = row.getAttribute('data-item-text');
                const itemSection = row.getAttribute('data-section');
                const itemChecked = row.getAttribute('data-checked') === 'true';
                const itemQuantity = parseInt(row.getAttribute('data-quantity')) || 1;
                
                itemsArray.push({
                    _id: itemId,
                    text: itemText,
                    section: itemSection,
                    checked: itemChecked,
                    quantity: itemQuantity
                });
            });
            
            itemsArray.push({
                _id: result.item_id,
                text: text,
                section: null,
                checked: false,
                quantity: 1
            });
            
            rebuildItemsList(itemsArray);
        } else {
            showModal(`‚úó ${result.message}`, 'error');
            itemInput.value = text;
        }
        
        itemInput.focus();
    } catch (error) {
        console.error('Error adding item:', error);
        showModal('‚úó Failed to add item. Please try again.', 'error');
        itemInput.value = text;
        itemInput.focus();
    } finally {
        addBtn.disabled = false;
        addBtn.textContent = originalBtnText;
        addBtn.style.opacity = '1';
    }
}

async function deleteItemByRow(itemId, event) {
    if (!isOwner && !isCollaborator) return;
    
    if (longPressTriggered) {
        event.preventDefault();
        event.stopPropagation();
        setTimeout(() => {
            longPressTriggered = false;
        }, 100);
        return;
    }
    
    const target = event.target;
    if (target.classList.contains('quantity-btn') || target.classList.contains('item-checkbox')) {
        return;
    }
    
    const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
    const itemText = itemRow.getAttribute('data-item-text');
    const itemSection = itemRow.getAttribute('data-section');
    
    const endpoint = (isEthereal && currentMode === 'edit')
        ? `/api/lists/${listId}/original/items/${itemId}`
        : `/api/lists/${listId}/items/${itemId}`;
    
    const response = await fetch(endpoint, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    if (response.ok) {
        undoStack.push({ id: itemId, text: itemText, section: itemSection });
        if (undoStack.length > MAX_UNDO) {
            undoStack.shift();
        }
        updateUndoButton();
        
        itemRow.remove();
        
        if (document.querySelectorAll('[data-item-id]').length === 0) {
            document.getElementById('items-list').innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary);">No items yet. Start adding items above!</p>';
        }
    }
}

async function adjustQuantity(itemId, delta, event) {
    event.stopPropagation();
    
    const response = await fetch(`/api/lists/${listId}/items/${itemId}/quantity`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ delta })
    });
    
    if (response.ok) {
        const result = await response.json();
        const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
        itemRow.setAttribute('data-quantity', result.quantity);
        
        const itemTextSpan = itemRow.querySelector('.item-text');
        const existingQtySpan = itemTextSpan.nextElementSibling;
        if (existingQtySpan && existingQtySpan.textContent.startsWith('x')) {
            existingQtySpan.remove();
        }
        
        if (result.quantity > 1) {
            const qtySpan = document.createElement('span');
            qtySpan.className = 'text-sm';
            qtySpan.style.color = 'var(--text-secondary)';
            qtySpan.textContent = `x${result.quantity}`;
            itemTextSpan.parentNode.appendChild(qtySpan);
        }
        
        const decreaseBtn = itemRow.querySelector('[data-action="decrease"]');
        if (decreaseBtn) {
            if (result.quantity <= 1) {
                decreaseBtn.classList.add('invisible');
            } else {
                decreaseBtn.classList.remove('invisible');
            }
        }
    }
}

function updateUndoButton() {
    const undoBtn = document.getElementById('undo-btn');
    const undoCount = document.getElementById('undo-count');
    
    if (undoStack.length > 0) {
        undoBtn.classList.remove('hidden');
        undoCount.textContent = undoStack.length;
    } else {
        undoBtn.classList.add('hidden');
    }
    
    saveUndoStack();
}

async function undoDelete() {
    if (undoStack.length === 0) return;
    
    const item = undoStack.pop();
    
    // Check if item already exists in the list
    const existingItems = Array.from(document.querySelectorAll('.item-text'));
    const itemExists = existingItems.some(el => el.textContent.toLowerCase() === item.text.toLowerCase());
    
    if (itemExists) {
        showModal('‚úó Item already exists in the list', 'error');
        updateUndoButton();
        return;
    }
    
    updateUndoButton();
    
    const endpoint = (isEthereal && currentMode === 'edit') 
        ? `/api/lists/${listId}/original/items`
        : `/api/lists/${listId}/items`;
    
    const requestBody = { text: item.text };
    if (item.section && item.section !== 'null' && item.section !== 'undefined') {
        requestBody.section = item.section;
    }
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestBody)
    });
    
    if (response.ok) {
        const result = await response.json();
        
        // Fetch updated items and rebuild the list
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
            showModal('‚úì Item restored', 'success');
        }
    }
}

function showUndoModal() {
    if (undoStack.length === 0) {
        showModal('‚úó No items to restore', 'error');
        return;
    }
    
    if (window.getSelection) {
        window.getSelection().removeAllRanges();
    } else if (document.selection) {
        document.selection.empty();
    }
    
    const modal = document.getElementById('undo-modal');
    const modalList = document.getElementById('undo-modal-list');
    
    // Create a map of unique items (most recent occurrence of each text)
    const uniqueItems = new Map();
    undoStack.forEach((item, index) => {
        const key = item.text.toLowerCase();
        if (!uniqueItems.has(key) || uniqueItems.get(key).index < index) {
            uniqueItems.set(key, { item, index });
        }
    });
    
    // Convert to array and sort by index descending (most recent first)
    const itemsToDisplay = Array.from(uniqueItems.values())
        .sort((a, b) => b.index - a.index);
    
    modalList.innerHTML = itemsToDisplay.map(({ item, index }) => `
        <div class="flex items-center justify-between p-3 rounded cursor-pointer hover:bg-opacity-80 transition-colors"
             style="background-color: var(--bg-primary);"
             onclick="restoreFromModalByIndex(${index})"
             data-undo-index="${index}">
            <span>${item.text}</span>
        </div>
    `).join('');
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeUndoModal(event) {
    if (event && event.target.id !== 'undo-modal') {
        return;
    }
    
    const modal = document.getElementById('undo-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

async function restoreFromModal(index) {
    const reversedIndex = undoStack.length - 1 - index;
    const item = undoStack[reversedIndex];
    
    // Check if item already exists in the list
    const existingItems = Array.from(document.querySelectorAll('.item-text'));
    const itemExists = existingItems.some(el => el.textContent.toLowerCase() === item.text.toLowerCase());
    
    if (itemExists) {
        showModal('‚úó Item already exists in the list', 'error');
        closeUndoModal();
        return;
    }
    
    undoStack.splice(reversedIndex, 1);
    updateUndoButton();
    
    const endpoint = (isEthereal && currentMode === 'edit') 
        ? `/api/lists/${listId}/original/items`
        : `/api/lists/${listId}/items`;
    
    const requestBody = { text: item.text };
    if (item.section && item.section !== 'null' && item.section !== 'undefined') {
        requestBody.section = item.section;
    }
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestBody)
    });
    
    const result = await response.json();
    
    if (result.success) {
        // Fetch updated items and rebuild the list
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
            showModal('‚úì Item restored', 'success');
        }
        
        if (undoStack.length === 0) {
            closeUndoModal();
        } else {
            showUndoModal();
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
        closeUndoModal();
    }
}

async function restoreFromModalByIndex(stackIndex) {
    const item = undoStack[stackIndex];
    
    // Check if item already exists in the list
    const existingItems = Array.from(document.querySelectorAll('.item-text'));
    const itemExists = existingItems.some(el => el.textContent.toLowerCase() === item.text.toLowerCase());
    
    if (itemExists) {
        showModal('‚úó Item already exists in the list', 'error');
        closeUndoModal();
        return;
    }
    
    undoStack.splice(stackIndex, 1);
    updateUndoButton();
    
    const endpoint = (isEthereal && currentMode === 'edit') 
        ? `/api/lists/${listId}/original/items`
        : `/api/lists/${listId}/items`;
    
    const requestBody = { text: item.text };
    if (item.section && item.section !== 'null' && item.section !== 'undefined') {
        requestBody.section = item.section;
    }
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(requestBody)
    });
    
    const result = await response.json();
    
    if (result.success) {
        // Fetch updated items and rebuild the list
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
            showModal('‚úì Item restored', 'success');
        }
        
        if (undoStack.length === 0) {
            closeUndoModal();
        } else {
            showUndoModal();
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
        closeUndoModal();
    }
}

async function restoreList() {
    const isCheckOffMode = currentMode === 'checkOff';
    const confirmMessage = isCheckOffMode 
        ? 'Uncheck all items?' 
        : 'Restore list to original items? Current items will be replaced.';
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/restore`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ reset_checked_only: isCheckOffMode })
    });
    
    const result = await response.json();
    
    if (result.success) {
        const message = isCheckOffMode ? '‚úì All items unchecked' : '‚úì List restored successfully';
        showModal(message, 'success');
        
        if (isCheckOffMode) {
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.item-text').forEach(text => {
                text.classList.remove('line-through');
            });
            document.querySelectorAll('.item-row').forEach(row => {
                row.classList.remove('opacity-50');
            });
        } else {
            setTimeout(() => location.reload(), 1000);
        }
    } else {
        showModal('‚úó Failed to restore list', 'error');
    }
}
{% endif %}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this list? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}

function cloneList() {
    if (confirm('Clone this list? A copy will be created and added to your lists.')) {
        document.getElementById('clone-form').submit();
    }
}

async function showChildrenModal() {
    const modal = document.getElementById('children-modal');
    const childrenList = document.getElementById('children-list');
    
    childrenList.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Loading...</p>';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    try {
        const response = await fetch(`/api/lists/${listId}/children`);
        const data = await response.json();
        
        if (data.children && data.children.length > 0) {
            childrenList.innerHTML = data.children.map(child => `
                <a href="/lists/${child.id}" class="block p-3 rounded card hover:opacity-80">
                    <div class="font-semibold">${child.name}</div>
                    <div class="text-sm" style="color: var(--text-secondary);">by @${child.owner_username}</div>
                </a>
            `).join('');
        } else {
            childrenList.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">No cloned lists found</p>';
        }
    } catch (error) {
        console.error('Error loading children:', error);
        childrenList.innerHTML = '<p class="text-center text-red-500">Error loading cloned lists</p>';
    }
}

function closeChildrenModal(event) {
    if (event && event.target.id !== 'children-modal') {
        return;
    }
    
    const modal = document.getElementById('children-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

{% if not is_owner %}
async function toggleFavorite() {
    const response = await fetch(`/api/favorite/${listId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    const result = await response.json();
    
    if (result.success) {
        const btn = document.getElementById('favorite-btn');
        const icon = document.getElementById('favorite-icon');
        const text = document.getElementById('favorite-text');
        
        if (result.favorited) {
            btn.classList.remove('card');
            btn.classList.add('bg-yellow-600');
            icon.textContent = '‚≠ê';
            text.textContent = 'Favorited';
        } else {
            btn.classList.add('card');
            btn.classList.remove('bg-yellow-600');
            icon.textContent = '‚òÜ';
            text.textContent = 'Favorite';
        }
    }
}
{% endif %}

function showModal(message, type) {
    const notification = document.getElementById('inline-notification');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    notification.className = `absolute w-full p-3 rounded text-white text-center ${bgColor}`;
    notification.style.top = '100%';
    notification.style.marginTop = '8px';
    notification.style.zIndex = '50';
    notification.textContent = message;
    notification.classList.remove('hidden');
    
    const duration = type === 'success' ? 2000 : 3000;
    setTimeout(() => {
        notification.classList.add('hidden');
    }, duration);
}

function toggleListMenu() {
    const dropdown = document.getElementById('list-menu-dropdown');
    dropdown.classList.toggle('hidden');
}

function createSectionFromItem() {
    if (!contextMenuItemId || !contextMenuItemText) return;
    
    createSectionItemId = contextMenuItemId;
    hideContextMenu();
    
    const modal = document.getElementById('create-section-modal');
    const input = document.getElementById('section-name-input');
    
    input.value = '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        input.focus();
    }, 100);
}

function closeCreateSectionModal(event) {
    if (event && event.target.id !== 'create-section-modal') {
        return;
    }
    
    const modal = document.getElementById('create-section-modal');
    const sectionAutocomplete = document.getElementById('section-autocomplete');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    sectionAutocomplete.classList.add('hidden');
}

async function saveNewSection() {
    const input = document.getElementById('section-name-input');
    const sectionName = input.value.trim();
    
    if (!sectionName || !createSectionItemId) {
        closeCreateSectionModal();
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/sections`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            item_id: createSectionItemId,
            section_name: sectionName
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Section created successfully', 'success');
        
        const itemRow = document.querySelector(`[data-item-id="${createSectionItemId}"]`);
        if (itemRow) {
            itemRow.setAttribute('data-section', sectionName);
            
            const itemsList = document.getElementById('items-list');
            const itemsListHtml = itemsList.innerHTML;
            
            const itemsArray = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const itemId = row.getAttribute('data-item-id');
                const itemText = row.getAttribute('data-item-text');
                const itemSection = row.getAttribute('data-section');
                const itemChecked = row.getAttribute('data-checked') === 'true';
                const itemQuantity = parseInt(row.getAttribute('data-quantity')) || 1;
                
                itemsArray.push({
                    _id: itemId,
                    text: itemText,
                    section: itemSection,
                    checked: itemChecked,
                    quantity: itemQuantity
                });
            });
            
            rebuildItemsList(itemsArray);
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    closeCreateSectionModal();
    createSectionItemId = null;
}

async function promoteToSection() {
    if (!contextMenuItemId || !contextMenuItemText) return;
    
    const itemId = contextMenuItemId;
    const sectionName = contextMenuItemText;
    
    hideContextMenu();
    
    const response = await fetch(`/api/lists/${listId}/promote-to-section`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            item_id: itemId,
            section_name: sectionName
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal(`‚úì Item promoted to section "${sectionName}"`, 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items, listData.empty_sections || []);
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeJs(text) {
    return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

function rebuildItemsList(items, emptySections = []) {
    const sections = {};
    const looseItems = [];
    
    items.forEach(item => {
        if (item.section) {
            if (!sections[item.section]) {
                sections[item.section] = [];
            }
            sections[item.section].push(item);
        } else {
            looseItems.push(item);
        }
    });
    
    emptySections.forEach(sectionName => {
        if (!sections[sectionName]) {
            sections[sectionName] = [];
        }
    });
    
    const sortedSections = Object.keys(sections).sort();
    
    let html = '';
    
    sortedSections.forEach(sectionName => {
        const sectionItems = isOrdered 
            ? sections[sectionName].sort((a, b) => (a.order || 0) - (b.order || 0))
            : sections[sectionName].sort((a, b) => a.text.localeCompare(b.text));
        const escapedSectionName = escapeHtml(sectionName);
        const jsSafeSectionName = escapeJs(sectionName);
        
        html += `<div class="section-group mb-4" data-section-name="${escapedSectionName}">`;
        html += `<div class="section-header flex items-center justify-between p-3 rounded-t font-semibold cursor-pointer" style="background-color: var(--bg-secondary); user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-section-name="${escapedSectionName}">`;
        html += `<span>${escapedSectionName}</span>`;
        
        if (isOwner || isCollaborator) {
            html += `<button onclick="showSectionAddModal('${jsSafeSectionName}', event)" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">‚ûï</button>`;
        }
        
        html += `</div><div class="section-items space-y-2 pt-2">`;
        
        sectionItems.forEach((item, index) => {
            const checkedClass = item.checked ? 'opacity-50' : '';
            const stripeClass = index % 2 === 0 ? 'section-item-even' : 'section-item-odd';
            const lineThrough = item.checked ? 'line-through' : '';
            const checkboxHidden = !isEthereal ? 'hidden' : '';
            const checked = item.checked ? 'checked' : '';
            const quantityVisible = item.quantity > 1 ? '' : 'invisible';
            const escapedItemText = escapeHtml(item.text);
            const escapedItemSection = escapeHtml(item.section);
            const jsSafeItemId = escapeJs(item._id);
            
            html += `<div class="flex items-center justify-between p-3 rounded item-row ${checkedClass} ${stripeClass}" style="cursor: pointer; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-item-id="${escapeHtml(item._id)}" data-item-text="${escapedItemText}" data-checked="${item.checked}" data-quantity="${item.quantity}" data-section="${escapedItemSection}" onclick="deleteItemByRow('${jsSafeItemId}', event)">`;
            html += `<div class="flex items-center gap-3 flex-1">`;
            html += `<input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer ${checkboxHidden}" onchange="toggleItemChecked('${jsSafeItemId}')" ${checked} onclick="event.stopPropagation()">`;
            
            if (isOrdered && showNumbering) {
                html += `<span class="item-number font-semibold" style="color: var(--text-secondary); min-width: 2em;">${index + 1}.</span>`;
            }
            
            html += `<span class="item-text ${lineThrough}">${escapedItemText}</span>`;
            
            if (item.quantity > 1) {
                html += `<span class="text-sm" style="color: var(--text-secondary);">x${escapeHtml(String(item.quantity))}</span>`;
            }
            
            html += `</div>`;
            
            if (isOwner || isCollaborator) {
                const decreaseHidden = isEthereal ? 'hidden' : '';
                const increaseHidden = isEthereal ? 'hidden' : '';
                html += `<div class="flex items-center gap-2">`;
                html += `<button class="quantity-btn ${decreaseHidden} ${quantityVisible} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${jsSafeItemId}', -1, event)" data-action="decrease">‚àí</button>`;
                html += `<button class="quantity-btn ${increaseHidden} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${jsSafeItemId}', 1, event)" data-action="increase">+</button>`;
                html += `</div>`;
            }
            
            html += `</div>`;
        });
        
        html += `</div></div>`;
    });
    
    const hasSections = Object.keys(sections).length > 0;
    
    if (looseItems.length > 0 || (hasSections && isOrdered)) {
        const sortedLooseItems = isOrdered
            ? looseItems.sort((a, b) => (a.order || 0) - (b.order || 0))
            : looseItems.sort((a, b) => a.text.localeCompare(b.text));
        
        html += `<div id="loose-items-drop-zone" class="loose-items-separator border-t-2 mt-6 pt-4" style="border-color: var(--border-color); transition: all 0.2s ease;">`;
        
        if (looseItems.length === 0 && hasSections && isOrdered) {
            html += `<div class="text-center py-6" style="color: var(--text-secondary);">`;
            html += `<p class="text-sm">Drop items here to remove from sections</p>`;
            html += `</div>`;
        } else {
            html += `<div class="space-y-2">`;
            
            sortedLooseItems.forEach((item, index) => {
                const checkedClass = item.checked ? 'opacity-50' : '';
                const lineThrough = item.checked ? 'line-through' : '';
                const checkboxHidden = !isEthereal ? 'hidden' : '';
                const checked = item.checked ? 'checked' : '';
                const quantityVisible = item.quantity > 1 ? '' : 'invisible';
                const escapedItemText = escapeHtml(item.text);
                const jsSafeItemId = escapeJs(item._id);
                
                html += `<div class="flex items-center justify-between p-3 rounded item-row ${checkedClass}" style="background-color: var(--bg-primary); cursor: pointer; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;" data-item-id="${escapeHtml(item._id)}" data-item-text="${escapedItemText}" data-checked="${item.checked}" data-quantity="${item.quantity}" onclick="deleteItemByRow('${jsSafeItemId}', event)">`;
                html += `<div class="flex items-center gap-3 flex-1">`;
                html += `<input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer ${checkboxHidden}" onchange="toggleItemChecked('${jsSafeItemId}')" ${checked} onclick="event.stopPropagation()">`;
                
                if (isOrdered && showNumbering) {
                    html += `<span class="item-number font-semibold" style="color: var(--text-secondary); min-width: 2em;">${index + 1}.</span>`;
                }
                
                html += `<span class="item-text ${lineThrough}">${escapedItemText}</span>`;
                
                if (item.quantity > 1) {
                    html += `<span class="text-sm" style="color: var(--text-secondary);">x${escapeHtml(String(item.quantity))}</span>`;
                }
                
                html += `</div>`;
                
                if (isOwner || isCollaborator) {
                    const decreaseHidden = isEthereal ? 'hidden' : '';
                    const increaseHidden = isEthereal ? 'hidden' : '';
                    html += `<div class="flex items-center gap-2">`;
                    html += `<button class="quantity-btn ${decreaseHidden} ${quantityVisible} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${jsSafeItemId}', -1, event)" data-action="decrease">‚àí</button>`;
                    html += `<button class="quantity-btn ${increaseHidden} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${jsSafeItemId}', 1, event)" data-action="increase">+</button>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            });
            
            html += `</div>`;
        }
        
        html += `</div>`;
    }
    
    document.getElementById('items-list').innerHTML = html;
    setupItemEventListeners();
}

let renamingSectionName = null;
let deletingSectionName = null;

function renameSectionFromMenu() {
    if (!contextMenuSectionName) return;
    
    renamingSectionName = contextMenuSectionName;
    hideContextMenu();
    
    const modal = document.getElementById('rename-section-modal');
    const input = document.getElementById('rename-section-input');
    
    input.value = renamingSectionName;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeRenameSectionModal(event) {
    if (event && event.target.id !== 'rename-section-modal') {
        return;
    }
    
    const modal = document.getElementById('rename-section-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    renamingSectionName = null;
}

async function saveRenamedSection() {
    const input = document.getElementById('rename-section-input');
    const newSectionName = input.value.trim();
    const oldSectionName = renamingSectionName;
    
    if (!newSectionName || !oldSectionName || newSectionName === oldSectionName) {
        closeRenameSectionModal();
        renamingSectionName = null;
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/sections/${encodeURIComponent(oldSectionName)}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ new_section_name: newSectionName })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Section renamed successfully', 'success');
        
        // Fetch updated items and rebuild the list
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    closeRenameSectionModal();
    renamingSectionName = null;
}

function deleteSectionFromMenu() {
    if (!contextMenuSectionName) return;
    
    deletingSectionName = contextMenuSectionName;
    hideContextMenu();
    
    const modal = document.getElementById('delete-section-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeDeleteSectionModal(event) {
    if (event && event.target.id !== 'delete-section-modal') {
        return;
    }
    
    const modal = document.getElementById('delete-section-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    deletingSectionName = null;
}

async function confirmDeleteSection() {
    const sectionToDelete = deletingSectionName;
    
    if (!sectionToDelete) {
        closeDeleteSectionModal();
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/sections/${encodeURIComponent(sectionToDelete)}`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Section deleted successfully', 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items, listData.empty_sections || []);
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    closeDeleteSectionModal();
    deletingSectionName = null;
}

let currentSectionForAdd = null;

function showSectionAddModal(sectionName, event) {
    if (event) {
        event.stopPropagation();
    }
    
    currentSectionForAdd = sectionName;
    
    const modal = document.getElementById('section-add-item-modal');
    const input = document.getElementById('section-item-input');
    const title = document.getElementById('section-add-title');
    
    title.textContent = sectionName;
    input.value = '';
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        input.focus();
    }, 100);
}

function closeSectionAddModal(event) {
    if (event && event.target.id !== 'section-add-item-modal') {
        return;
    }
    
    const modal = document.getElementById('section-add-item-modal');
    const autocomplete = document.getElementById('section-autocomplete');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    autocomplete.classList.add('hidden');
    currentSectionForAdd = null;
}

async function addItemToSection() {
    const input = document.getElementById('section-item-input');
    const itemText = input.value.trim();
    const sectionName = currentSectionForAdd;
    
    if (!itemText || !sectionName) {
        closeSectionAddModal();
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/items`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            text: itemText,
            section: sectionName
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item added successfully', 'success');
        
        const itemsArray = [];
        document.querySelectorAll('.item-row').forEach(row => {
            const itemId = row.getAttribute('data-item-id');
            const itemText = row.getAttribute('data-item-text');
            const itemSection = row.getAttribute('data-section');
            const itemChecked = row.getAttribute('data-checked') === 'true';
            const itemQuantity = parseInt(row.getAttribute('data-quantity')) || 1;
            
            itemsArray.push({
                _id: itemId,
                text: itemText,
                section: itemSection,
                checked: itemChecked,
                quantity: itemQuantity
            });
        });
        
        itemsArray.push({
            _id: result.item_id,
            text: itemText,
            section: sectionName,
            checked: false,
            quantity: 1
        });
        
        rebuildItemsList(itemsArray);
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    closeSectionAddModal();
}

const sectionItemInput = document.getElementById('section-item-input');
const sectionAutocomplete = document.getElementById('section-autocomplete');

if (sectionItemInput && sectionAutocomplete) {
    sectionItemInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            sectionAutocomplete.classList.add('hidden');
            return;
        }
        
        const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
        const suggestions = await response.json();
        
        if (suggestions.length > 0) {
            sectionAutocomplete.innerHTML = suggestions.map(s => 
                `<div class="p-2 hover:bg-opacity-80 cursor-pointer" style="background-color: var(--bg-primary);" onclick="selectSectionSuggestion('${s}')">${s}</div>`
            ).join('');
            sectionAutocomplete.classList.remove('hidden');
        } else {
            sectionAutocomplete.classList.add('hidden');
        }
    });
    
    sectionItemInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addItemToSection();
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!sectionAutocomplete.contains(e.target) && e.target !== sectionItemInput) {
            sectionAutocomplete.classList.add('hidden');
        }
    });
}

function selectSectionSuggestion(text) {
    const input = document.getElementById('section-item-input');
    input.value = text;
    document.getElementById('section-autocomplete').classList.add('hidden');
    addItemToSection();
}

function selectCreateSectionSuggestion(text) {
    const input = document.getElementById('section-name-input');
    input.value = text;
    document.getElementById('section-autocomplete').classList.add('hidden');
    input.focus();
}

document.getElementById('section-name-input').addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    const sectionAutocomplete = document.getElementById('section-autocomplete');
    
    if (query.length < 2) {
        sectionAutocomplete.classList.add('hidden');
        return;
    }
    
    const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    
    if (suggestions.length > 0) {
        sectionAutocomplete.innerHTML = suggestions.map(s => 
            `<div class="p-2 hover:bg-opacity-80 cursor-pointer" style="background-color: var(--bg-primary);" onclick="selectCreateSectionSuggestion('${escapeJs(s)}')">${escapeHtml(s)}</div>`
        ).join('');
        sectionAutocomplete.classList.remove('hidden');
    } else {
        sectionAutocomplete.classList.add('hidden');
    }
});

document.getElementById('section-name-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveNewSection();
    }
});

document.getElementById('rename-section-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveRenamedSection();
    }
});

document.addEventListener('click', (e) => {
    const menuContainer = document.getElementById('list-menu-container');
    const dropdown = document.getElementById('list-menu-dropdown');
    
    if (menuContainer && !menuContainer.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
    
    const sectionAutocomplete = document.getElementById('section-autocomplete');
    const sectionNameInput = document.getElementById('section-name-input');
    if (sectionAutocomplete && sectionNameInput && !sectionAutocomplete.contains(e.target) && e.target !== sectionNameInput) {
        sectionAutocomplete.classList.add('hidden');
    }
});

let moveToSectionItemId = null;

function showMoveToSectionModal() {
    if (!contextMenuItemId || !contextMenuItemText) return;
    
    moveToSectionItemId = contextMenuItemId;
    const itemText = contextMenuItemText;
    
    const itemRow = document.querySelector(`[data-item-id="${moveToSectionItemId}"]`);
    const currentSection = itemRow ? itemRow.getAttribute('data-section') : null;
    
    hideContextMenu();
    
    const modal = document.getElementById('move-to-section-modal');
    const itemNameSpan = document.getElementById('move-item-name');
    const sectionList = document.getElementById('section-list');
    
    itemNameSpan.textContent = itemText;
    
    const sections = new Set();
    document.querySelectorAll('.section-header').forEach(header => {
        const sectionName = header.getAttribute('data-section-name');
        if (sectionName && sectionName !== currentSection) {
            sections.add(sectionName);
        }
    });
    
    const sortedSections = Array.from(sections).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
    
    let html = '';
    
    if (currentSection) {
        html += `<div class="flex items-center justify-between p-3 rounded cursor-pointer hover:bg-opacity-80 transition-colors" 
                     style="background-color: var(--bg-primary);"
                     onclick="moveItemToSection(null)">
                    <span>üîì Loose Items (Remove from section)</span>
                </div>`;
    }
    
    sortedSections.forEach(sectionName => {
        const escapedSection = sectionName.replace(/'/g, "\\'");
        html += `<div class="flex items-center justify-between p-3 rounded cursor-pointer hover:bg-opacity-80 transition-colors" 
                     style="background-color: var(--bg-primary);"
                     onclick="moveItemToSection('${escapedSection}')">
                    <span>üìÅ ${sectionName}</span>
                </div>`;
    });
    
    if (html === '') {
        html = '<p class="text-center py-4" style="color: var(--text-secondary);">No other sections available</p>';
    }
    
    sectionList.innerHTML = html;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeMoveToSectionModal(event) {
    if (event && event.target.id !== 'move-to-section-modal') {
        return;
    }
    
    const modal = document.getElementById('move-to-section-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    moveToSectionItemId = null;
}

async function moveItemToSection(sectionName) {
    if (!moveToSectionItemId) {
        closeMoveToSectionModal();
        return;
    }
    
    const itemId = moveToSectionItemId;
    
    const response = await fetch(`/api/lists/${listId}/sections`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            item_id: itemId,
            section_name: sectionName || ''
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        const message = sectionName 
            ? `‚úì Item moved to "${sectionName}"` 
            : '‚úì Item moved to loose items';
        showModal(message, 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items);
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    closeMoveToSectionModal();
}

function enterMoveMode() {
    if (!isOrdered) {
        showModal('‚úó This list is not ordered', 'error');
        return;
    }
    
    hideContextMenu();
    
    moveModeActive = true;
    
    const exitBtn = document.getElementById('exit-move-mode-btn');
    exitBtn.classList.remove('hidden');
    
    const itemRows = document.querySelectorAll('.item-row');
    itemRows.forEach(row => {
        row.style.cursor = 'grab';
        row.setAttribute('draggable', 'true');
        
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragenter', handleDragEnter);
        row.addEventListener('dragleave', handleDragLeave);
        
        row.addEventListener('touchstart', handleTouchStart, { passive: false });
        row.addEventListener('touchmove', handleTouchMove, { passive: false });
        row.addEventListener('touchend', handleTouchEnd, { passive: false });
    });
    
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.addEventListener('dragover', handleSectionDragOver);
        header.addEventListener('drop', handleSectionDrop);
        header.addEventListener('dragleave', handleSectionDragLeave);
        header.addEventListener('dragenter', handleSectionDragEnter);
        
        header.addEventListener('touchmove', handleSectionTouchMove, { passive: false });
        header.addEventListener('touchend', handleSectionTouchEnd, { passive: false });
    });
    
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.addEventListener('dragover', handleLooseItemsDragOver);
        looseItemsZone.addEventListener('drop', handleLooseItemsDrop);
        looseItemsZone.addEventListener('dragleave', handleLooseItemsDragLeave);
        looseItemsZone.addEventListener('dragenter', handleLooseItemsDragEnter);
        
        looseItemsZone.addEventListener('touchmove', handleLooseItemsTouchMove, { passive: false });
        looseItemsZone.addEventListener('touchend', handleLooseItemsTouchEnd, { passive: false });
    }
    
    showModal('‚úì Move mode activated - Drag items to reorder or move to sections', 'success');
}

function exitMoveMode() {
    moveModeActive = false;
    
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        autoScrollInterval = null;
    }
    
    const exitBtn = document.getElementById('exit-move-mode-btn');
    exitBtn.classList.add('hidden');
    
    const itemRows = document.querySelectorAll('.item-row');
    itemRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.removeAttribute('draggable');
        row.style.opacity = '1';
        row.style.transform = '';
        row.style.borderTop = '';
        
        row.removeEventListener('dragstart', handleDragStart);
        row.removeEventListener('dragover', handleDragOver);
        row.removeEventListener('drop', handleDrop);
        row.removeEventListener('dragend', handleDragEnd);
        row.removeEventListener('dragenter', handleDragEnter);
        row.removeEventListener('dragleave', handleDragLeave);
        
        row.removeEventListener('touchstart', handleTouchStart);
        row.removeEventListener('touchmove', handleTouchMove);
        row.removeEventListener('touchend', handleTouchEnd);
    });
    
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
        header.removeEventListener('dragover', handleSectionDragOver);
        header.removeEventListener('drop', handleSectionDrop);
        header.removeEventListener('dragleave', handleSectionDragLeave);
        header.removeEventListener('dragenter', handleSectionDragEnter);
        header.removeEventListener('touchmove', handleSectionTouchMove);
        header.removeEventListener('touchend', handleSectionTouchEnd);
    });
    
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.style.backgroundColor = '';
        looseItemsZone.style.border = '';
        looseItemsZone.removeEventListener('dragover', handleLooseItemsDragOver);
        looseItemsZone.removeEventListener('drop', handleLooseItemsDrop);
        looseItemsZone.removeEventListener('dragleave', handleLooseItemsDragLeave);
        looseItemsZone.removeEventListener('dragenter', handleLooseItemsDragEnter);
        looseItemsZone.removeEventListener('touchmove', handleLooseItemsTouchMove);
        looseItemsZone.removeEventListener('touchend', handleLooseItemsTouchEnd);
    }
    
    if (dragPlaceholder) {
        dragPlaceholder.remove();
        dragPlaceholder = null;
    }
    
    draggedItemElement = null;
    touchTargetElement = null;
    
    showModal('‚úì Move mode deactivated', 'success');
}

function handleDragStart(e) {
    draggedItemElement = e.target.closest('.item-row');
    draggedItem = {
        id: draggedItemElement.getAttribute('data-item-id'),
        text: draggedItemElement.getAttribute('data-item-text')
    };
    
    draggedItemElement.style.opacity = '0.4';
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    const targetRow = e.target.closest('.item-row');
    if (targetRow && targetRow !== draggedItemElement) {
        targetRow.style.borderTop = '3px solid #3b82f6';
    }
}

function handleDragLeave(e) {
    const targetRow = e.target.closest('.item-row');
    if (targetRow && targetRow !== draggedItemElement) {
        targetRow.style.borderTop = '';
    }
}

async function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    const targetRow = e.target.closest('.item-row');
    targetRow.style.borderTop = '';
    
    if (!draggedItemElement || !targetRow || draggedItemElement === targetRow) {
        return false;
    }
    
    const allItems = Array.from(document.querySelectorAll('.item-row'));
    const draggedIndex = allItems.indexOf(draggedItemElement);
    const targetIndex = allItems.indexOf(targetRow);
    
    if (targetIndex > draggedIndex) {
        targetRow.parentNode.insertBefore(draggedItemElement, targetRow.nextSibling);
    } else {
        targetRow.parentNode.insertBefore(draggedItemElement, targetRow);
    }
    
    updateItemNumbers();
    
    const itemOrders = {};
    const updatedItems = Array.from(document.querySelectorAll('.item-row'));
    updatedItems.forEach((row, index) => {
        const itemId = row.getAttribute('data-item-id');
        itemOrders[itemId] = index;
    });
    
    const response = await fetch(`/api/lists/${listId}/items/reorder`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ item_orders: itemOrders })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item moved successfully', 'success');
    } else {
        showModal('‚úó Failed to reorder items', 'error');
    }
    
    return false;
}

function updateItemNumbers() {
    if (!isOrdered || !showNumbering) return;
    
    const allRows = document.querySelectorAll('.item-row');
    allRows.forEach((row, index) => {
        const numberSpan = row.querySelector('.item-number');
        if (numberSpan) {
            numberSpan.textContent = `${index + 1}.`;
        }
    });
}

function handleDragEnd(e) {
    if (draggedItemElement) {
        draggedItemElement.style.opacity = '1';
    }
    
    const allRows = document.querySelectorAll('.item-row');
    allRows.forEach(row => {
        row.style.borderTop = '';
    });
    
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
    });
}

function handleSectionDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const sectionHeader = e.target.closest('.section-header');
    if (sectionHeader) {
        sectionHeader.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
        sectionHeader.style.border = '2px solid rgba(59, 130, 246, 0.8)';
    }
    
    return false;
}

function handleSectionDragEnter(e) {
    e.preventDefault();
    const sectionHeader = e.target.closest('.section-header');
    if (sectionHeader) {
        sectionHeader.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
        sectionHeader.style.border = '2px solid rgba(59, 130, 246, 0.8)';
    }
}

function handleSectionDragLeave(e) {
    const sectionHeader = e.target.closest('.section-header');
    if (sectionHeader) {
        sectionHeader.style.backgroundColor = '';
        sectionHeader.style.border = '';
    }
}

function handleSectionTouchMove(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    e.preventDefault();
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const sectionHeader = elementBelow ? elementBelow.closest('.section-header') : null;
    
    const allSectionHeaders = document.querySelectorAll('.section-header');
    allSectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
    });
    
    if (sectionHeader) {
        sectionHeader.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
        sectionHeader.style.border = '2px solid rgba(59, 130, 246, 0.8)';
    }
}

async function handleSectionDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const sectionHeader = e.target.closest('.section-header');
    if (!sectionHeader || !draggedItemElement) {
        return false;
    }
    
    sectionHeader.style.backgroundColor = '';
    sectionHeader.style.border = '';
    
    const sectionName = sectionHeader.getAttribute('data-section-name');
    const itemId = draggedItemElement.getAttribute('data-item-id');
    
    const response = await fetch(`/api/lists/${listId}/sections`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            item_id: itemId,
            section_name: sectionName
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal(`‚úì Item moved to section "${sectionName}"`, 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items, listData.empty_sections || []);
            reattachMoveEventListeners();
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    return false;
}

function reattachMoveEventListeners() {
    if (!moveModeActive) return;
    
    const itemRows = document.querySelectorAll('.item-row');
    itemRows.forEach(row => {
        row.style.cursor = 'grab';
        row.setAttribute('draggable', 'true');
        
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragenter', handleDragEnter);
        row.addEventListener('dragleave', handleDragLeave);
        
        row.addEventListener('touchstart', handleTouchStart, { passive: false });
        row.addEventListener('touchmove', handleTouchMove, { passive: false });
        row.addEventListener('touchend', handleTouchEnd, { passive: false });
    });
    
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
        header.addEventListener('dragover', handleSectionDragOver);
        header.addEventListener('drop', handleSectionDrop);
        header.addEventListener('dragleave', handleSectionDragLeave);
        header.addEventListener('dragenter', handleSectionDragEnter);
        
        header.addEventListener('touchmove', handleSectionTouchMove, { passive: false });
        header.addEventListener('touchend', handleSectionTouchEnd, { passive: false });
    });
    
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.addEventListener('dragover', handleLooseItemsDragOver);
        looseItemsZone.addEventListener('drop', handleLooseItemsDrop);
        looseItemsZone.addEventListener('dragleave', handleLooseItemsDragLeave);
        looseItemsZone.addEventListener('dragenter', handleLooseItemsDragEnter);
        
        looseItemsZone.addEventListener('touchmove', handleLooseItemsTouchMove, { passive: false });
        looseItemsZone.addEventListener('touchend', handleLooseItemsTouchEnd, { passive: false });
    }

async function handleSectionTouchEnd(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const sectionHeader = elementBelow ? elementBelow.closest('.section-header') : null;
    
    const allSectionHeaders = document.querySelectorAll('.section-header');
    allSectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
    });
    
    if (sectionHeader) {
        const sectionName = sectionHeader.getAttribute('data-section-name');
        const itemId = draggedItemElement.getAttribute('data-item-id');
        
        const response = await fetch(`/api/lists/${listId}/sections`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                item_id: itemId,
                section_name: sectionName
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showModal(`‚úì Item moved to section "${sectionName}"`, 'success');
            
            const listResponse = await fetch(`/api/lists/${listId}`);
            const listData = await listResponse.json();
            
            if (listData.success) {
                rebuildItemsList(listData.items, listData.empty_sections || []);
                reattachMoveEventListeners();
            }
        } else {
            showModal(`‚úó ${result.message}`, 'error');
        }
    }
    
    if (draggedItemElement) {
        draggedItemElement.style.opacity = '1';
        draggedItemElement.style.transform = '';
    }
    
    draggedItemElement = null;
}

function handleLooseItemsDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
        looseItemsZone.style.border = '3px solid rgba(59, 130, 246, 0.8)';
    }
    
    return false;
}

function handleLooseItemsDragEnter(e) {
    e.preventDefault();
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
        looseItemsZone.style.border = '3px solid rgba(59, 130, 246, 0.8)';
    }
}

function handleLooseItemsDragLeave(e) {
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (looseItemsZone) {
        looseItemsZone.style.backgroundColor = '';
        looseItemsZone.style.border = '';
    }
}

async function handleLooseItemsDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const looseItemsZone = document.getElementById('loose-items-drop-zone');
    if (!looseItemsZone || !draggedItemElement) {
        return false;
    }
    
    looseItemsZone.style.backgroundColor = '';
    looseItemsZone.style.border = '';
    
    const itemId = draggedItemElement.getAttribute('data-item-id');
    
    const response = await fetch(`/api/lists/${listId}/sections`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ 
            item_id: itemId,
            section_name: ''
        })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item moved to loose items', 'success');
        
        const listResponse = await fetch(`/api/lists/${listId}`);
        const listData = await listResponse.json();
        
        if (listData.success) {
            rebuildItemsList(listData.items, listData.empty_sections || []);
            reattachMoveEventListeners();
        }
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
    
    return false;
}

function handleLooseItemsTouchMove(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    if (e.target.closest('.item-row')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const looseItemsZone = elementBelow ? elementBelow.closest('#loose-items-drop-zone') : null;
    
    const zone = document.getElementById('loose-items-drop-zone');
    if (zone) {
        if (looseItemsZone) {
            zone.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
            zone.style.border = '3px solid rgba(59, 130, 246, 0.8)';
        } else {
            zone.style.backgroundColor = '';
            zone.style.border = '';
        }
    }
}

async function handleLooseItemsTouchEnd(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    if (e.target.closest('.item-row')) {
        return;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const looseItemsZone = elementBelow ? elementBelow.closest('#loose-items-drop-zone') : null;
    
    const zone = document.getElementById('loose-items-drop-zone');
    if (zone) {
        zone.style.backgroundColor = '';
        zone.style.border = '';
    }
    
    if (looseItemsZone) {
        const itemId = draggedItemElement.getAttribute('data-item-id');
        
        const response = await fetch(`/api/lists/${listId}/sections`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                item_id: itemId,
                section_name: ''
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showModal('‚úì Item moved to loose items', 'success');
            
            const listResponse = await fetch(`/api/lists/${listId}`);
            const listData = await listResponse.json();
            
            if (listData.success) {
                rebuildItemsList(listData.items, listData.empty_sections || []);
                reattachMoveEventListeners();
            }
        } else {
            showModal(`‚úó ${result.message}`, 'error');
        }
    }
    
    if (draggedItemElement) {
        draggedItemElement.style.opacity = '1';
        draggedItemElement.style.transform = '';
    }
    
    draggedItemElement = null;
}

function handleTouchStart(e) {
    if (!moveModeActive) return;
    
    draggedItemElement = e.target.closest('.item-row');
    if (!draggedItemElement) return;
    
    draggedItem = {
        id: draggedItemElement.getAttribute('data-item-id'),
        text: draggedItemElement.getAttribute('data-item-text')
    };
    
    touchStartY = e.touches[0].clientY;
    draggedItemElement.style.opacity = '0.4';
    draggedItemElement.style.transform = 'scale(1.05)';
    
    e.preventDefault();
}

function handleTouchMove(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    e.preventDefault();
    touchCurrentY = e.touches[0].clientY;
    
    const touch = e.touches[0];
    const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
    const targetRow = elementAtPoint ? elementAtPoint.closest('.item-row') : null;
    const sectionHeader = elementAtPoint ? elementAtPoint.closest('.section-header') : null;
    
    const allRows = document.querySelectorAll('.item-row');
    allRows.forEach(row => {
        if (row !== draggedItemElement) {
            row.style.borderTop = '';
        }
    });
    
    const allSectionHeaders = document.querySelectorAll('.section-header');
    allSectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
    });
    
    if (sectionHeader) {
        sectionHeader.style.backgroundColor = 'rgba(59, 130, 246, 0.5)';
        sectionHeader.style.border = '2px solid rgba(59, 130, 246, 0.8)';
    } else if (targetRow && targetRow !== draggedItemElement) {
        touchTargetElement = targetRow;
        targetRow.style.borderTop = '3px solid #3b82f6';
    }
    
    const windowHeight = window.innerHeight;
    const scrollThreshold = 100;
    
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        autoScrollInterval = null;
    }
    
    if (touch.clientY < scrollThreshold) {
        autoScrollInterval = setInterval(() => {
            window.scrollBy(0, -10);
        }, 50);
    } else if (touch.clientY > windowHeight - scrollThreshold) {
        autoScrollInterval = setInterval(() => {
            window.scrollBy(0, 10);
        }, 50);
    }
}

async function handleTouchEnd(e) {
    if (!moveModeActive || !draggedItemElement) return;
    
    e.preventDefault();
    
    if (autoScrollInterval) {
        clearInterval(autoScrollInterval);
        autoScrollInterval = null;
    }
    
    draggedItemElement.style.opacity = '1';
    draggedItemElement.style.transform = '';
    
    const allRows = document.querySelectorAll('.item-row');
    allRows.forEach(row => {
        row.style.borderTop = '';
    });
    
    const allSectionHeaders = document.querySelectorAll('.section-header');
    allSectionHeaders.forEach(header => {
        header.style.backgroundColor = '';
        header.style.border = '';
    });
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const sectionHeader = elementBelow ? elementBelow.closest('.section-header') : null;
    
    if (sectionHeader) {
        const sectionName = sectionHeader.getAttribute('data-section-name');
        const itemId = draggedItemElement.getAttribute('data-item-id');
        
        const response = await fetch(`/api/lists/${listId}/sections`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ 
                item_id: itemId,
                section_name: sectionName
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showModal(`‚úì Item moved to section "${sectionName}"`, 'success');
            
            const listResponse = await fetch(`/api/lists/${listId}`);
            const listData = await listResponse.json();
            
            if (listData.success) {
                rebuildItemsList(listData.items, listData.empty_sections || []);
                reattachMoveEventListeners();
            }
        } else {
            showModal(`‚úó ${result.message}`, 'error');
        }
        
        draggedItemElement = null;
        touchTargetElement = null;
        return;
    }
    
    if (!touchTargetElement || draggedItemElement === touchTargetElement) {
        draggedItemElement = null;
        touchTargetElement = null;
        return;
    }
    
    const allItems = Array.from(document.querySelectorAll('.item-row'));
    const draggedIndex = allItems.indexOf(draggedItemElement);
    const targetIndex = allItems.indexOf(touchTargetElement);
    
    if (targetIndex > draggedIndex) {
        touchTargetElement.parentNode.insertBefore(draggedItemElement, touchTargetElement.nextSibling);
    } else {
        touchTargetElement.parentNode.insertBefore(draggedItemElement, touchTargetElement);
    }
    
    updateItemNumbers();
    
    const itemOrders = {};
    const updatedItems = Array.from(document.querySelectorAll('.item-row'));
    updatedItems.forEach((row, index) => {
        const itemId = row.getAttribute('data-item-id');
        itemOrders[itemId] = index;
    });
    
    const response = await fetch(`/api/lists/${listId}/items/reorder`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ item_orders: itemOrders })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item moved successfully', 'success');
    } else {
        showModal('‚úó Failed to reorder items', 'error');
    }
    
    draggedItemElement = null;
    touchTargetElement = null;
}

window.addEventListener('scroll', function() {
    const exitBtn = document.getElementById('exit-move-mode-btn');
    if (exitBtn && !exitBtn.classList.contains('hidden')) {
        exitBtn.style.position = 'fixed';
        exitBtn.style.top = '20px';
    }
});
</script>
{% endblock %}
