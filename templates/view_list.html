{% extends "base.html" %}

{% block title %}{{ current_list.name }} - List Point{% endblock %}
{% block description %}View and manage {{ current_list.name }} on List Point. {% if current_list.tags %}Tags: {{ current_list.tags|join(', ') }}.{% endif %} {% if current_list.is_ethereal %}Check list with restore functionality.{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex items-center mb-4">
        <a href="{{ url_for('index') }}" class="text-blue-500 hover:underline">‚Üê Back</a>
    </div>
    
    {% if not current_user.is_authenticated or not current_user.subscription.get('is_ad_free', False) %}
    <div class="ad-container mb-4" style="display:none;min-height:0;overflow:hidden;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="{{ adsense_publisher_id }}"
             data-ad-slot="9050273015"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    {% endif %}
    
    {% if current_list.thumbnail_url %}
    <div class="mb-6">
        <img src="{{ current_list.thumbnail_url }}" alt="{{ current_list.name }}" class="w-full max-w-md h-48 object-cover rounded-lg">
    </div>
    {% endif %}
    
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-3xl font-bold mb-2">
                {{ current_list.name }}
                {% if current_list.is_ethereal %}
                    <span class="text-2xl">‚ú®</span>
                {% endif %}
            </h1>
            {% if current_list.tags %}
                <div class="flex flex-wrap gap-2 mb-2">
                    {% for tag in current_list.tags %}
                        <span class="text-sm px-3 py-1 rounded" style="background-color: var(--border-color); color: var(--text-secondary);">
                            #{{ tag }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
            {% if not is_owner %}
                <p class="text-sm" style="color: var(--text-secondary);">by @{{ current_list.owner_username }}</p>
            {% endif %}
        </div>
        
        <div class="flex items-center space-x-2 flex-wrap gap-2">
            {% if is_owner %}
                {% if current_list.is_ethereal %}
                    <button id="mode-toggle-btn" onclick="toggleMode()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        <span id="mode-toggle-text">üìù Edit Mode</span>
                    </button>
                    <button id="restore-btn" onclick="restoreList()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        <span id="restore-text">üîÑ Uncheck All</span>
                    </button>
                {% endif %}
                <a href="{{ url_for('edit_list', list_id=current_list._id) }}" class="card px-4 py-2 rounded hover:opacity-80">
                    Edit List
                </a>
                <button onclick="confirmDelete()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    Delete
                </button>
            {% else %}
                <button onclick="toggleFavorite()" id="favorite-btn" class="{% if is_favorited %}bg-yellow-600{% else %}card{% endif %} px-4 py-2 rounded hover:opacity-80">
                    <span id="favorite-icon">{% if is_favorited %}‚≠ê{% else %}‚òÜ{% endif %}</span>
                    <span id="favorite-text">{% if is_favorited %}Favorited{% else %}Favorite{% endif %}</span>
                </button>
            {% endif %}
        </div>
    </div>

    {% if is_owner or is_collaborator %}
        <div class="mb-6" id="add-item-section">
            <div class="relative">
                <input 
                    type="text" 
                    id="item-input" 
                    placeholder="Type to add item..." 
                    class="w-full p-3 rounded border pr-44"
                    style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
                    autocomplete="off"
                >
                <div class="absolute right-2 top-2 flex gap-2">
                    <button id="add-item-btn" onclick="addItem()" class="px-4 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                        Add
                    </button>
                    <button id="undo-btn" onclick="undoDelete()" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700 hidden">
                        ‚Ü∂ Undo (<span id="undo-count">0</span>)
                    </button>
                </div>
            </div>
            <div id="autocomplete" class="w-full card rounded shadow-lg hidden max-h-48 overflow-y-auto mt-2" style="position: relative; z-index: 1;"></div>
            <div id="inline-notification" class="w-full hidden mt-2 p-3 rounded text-white text-center"></div>
        </div>
    {% endif %}

    <div class="card p-6 rounded-lg">
        <div id="items-list" class="space-y-2">
            {% if current_list['items'] %}
                {% for item in current_list['items'] %}
                    <div class="flex items-center justify-between p-3 rounded item-row {% if item.get('checked') %}opacity-50{% endif %}" style="background-color: var(--bg-primary); cursor: pointer;" data-item-id="{{ item._id }}" data-item-text="{{ item.text }}" data-checked="{{ 'true' if item.get('checked') else 'false' }}" data-quantity="{{ item.get('quantity', 1) }}" onclick="deleteItemByRow('{{ item._id }}', event)">
                        <div class="flex items-center gap-3 flex-1">
                            <input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer {% if not current_list.is_ethereal %}hidden{% endif %}" 
                                   onchange="toggleItemChecked('{{ item._id }}')" 
                                   {% if item.get('checked') %}checked{% endif %}
                                   onclick="event.stopPropagation()">
                            <span class="item-text {% if item.get('checked') %}line-through{% endif %}">{{ item.text }}</span>
                            {% if item.get('quantity', 1) > 1 %}
                                <span class="text-sm" style="color: var(--text-secondary);">x{{ item.get('quantity', 1) }}</span>
                            {% endif %}
                        </div>
                        {% if is_owner or is_collaborator %}
                            <div class="flex items-center gap-2">
                                <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} {% if item.get('quantity', 1) <= 1 %}invisible{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', -1, event)" data-action="decrease">
                                    ‚àí
                                </button>
                                <button class="quantity-btn {% if current_list.is_ethereal %}hidden{% endif %} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('{{ item._id }}', 1, event)" data-action="increase">
                                    +
                                </button>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center py-8" style="color: var(--text-secondary);">
                    No items yet. {% if is_owner or is_collaborator %}Start adding items above!{% endif %}
                </p>
            {% endif %}
        </div>
    </div>
</div>

<div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeEditModal(event)">
    <div class="card p-6 rounded-lg max-w-md w-full mx-4 fade-in" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">Edit Item</h3>
        <input 
            type="text" 
            id="edit-item-input" 
            class="w-full p-3 rounded border mb-4"
            style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);"
            placeholder="Enter item text..."
        >
        <div class="flex justify-end gap-3">
            <button 
                onclick="closeEditModal()" 
                class="px-4 py-2 rounded card hover:opacity-80"
            >
                Cancel
            </button>
            <button 
                onclick="saveEditedItem()" 
                class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
            >
                Save
            </button>
        </div>
    </div>
</div>

<form id="delete-form" method="POST" action="{{ url_for('delete_list', list_id=current_list._id) }}" class="hidden">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
</form>

{% endblock %}

{% block extra_js %}
<script>
const listId = '{{ current_list._id }}';
const csrfToken = '{{ csrf_token() }}';
const isOwner = {{ 'true' if is_owner else 'false' }};
const isCollaborator = {{ 'true' if is_collaborator else 'false' }};
const isEthereal = {{ 'true' if current_list.is_ethereal else 'false' }};
let undoStack = [];
const MAX_UNDO = 10;
let currentMode = 'checkOff';

function toggleMode() {
    if (!isEthereal || !isOwner) return;
    
    currentMode = currentMode === 'checkOff' ? 'edit' : 'checkOff';
    updateUIForMode();
}

function updateUIForMode() {
    const modeToggleText = document.getElementById('mode-toggle-text');
    const restoreText = document.getElementById('restore-text');
    const addItemSection = document.getElementById('add-item-section');
    const checkboxes = document.querySelectorAll('.item-checkbox');
    const deleteButtons = document.querySelectorAll('.item-delete-btn');
    
    if (currentMode === 'edit') {
        if (modeToggleText) modeToggleText.textContent = '‚òë Check Off Mode';
        if (restoreText) restoreText.textContent = 'üîÑ Restore to Original';
        if (addItemSection) addItemSection.style.display = 'block';
        checkboxes.forEach(cb => cb.classList.add('hidden'));
        deleteButtons.forEach(btn => btn.classList.remove('hidden'));
    } else {
        if (modeToggleText) modeToggleText.textContent = 'üìù Edit Mode';
        if (restoreText) restoreText.textContent = 'üîÑ Uncheck All';
        if (addItemSection) addItemSection.style.display = 'none';
        checkboxes.forEach(cb => cb.classList.remove('hidden'));
        deleteButtons.forEach(btn => btn.classList.add('hidden'));
    }
}

async function toggleItemChecked(itemId) {
    const response = await fetch(`/api/lists/${listId}/items/${itemId}/toggle`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    if (response.ok) {
        const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
        const checkbox = itemRow.querySelector('.item-checkbox');
        const itemText = itemRow.querySelector('.item-text');
        const isChecked = checkbox.checked;
        
        if (isChecked) {
            itemText.classList.add('line-through');
            itemRow.classList.add('opacity-50');
        } else {
            itemText.classList.remove('line-through');
            itemRow.classList.remove('opacity-50');
        }
    }
}

if (isEthereal && isOwner) {
    updateUIForMode();
}

{% if is_owner or is_collaborator %}
const itemInput = document.getElementById('item-input');
const autocomplete = document.getElementById('autocomplete');

itemInput.addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        autocomplete.classList.add('hidden');
        return;
    }
    
    const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
    const suggestions = await response.json();
    
    if (suggestions.length > 0) {
        autocomplete.innerHTML = suggestions.map(s => 
            `<div class="p-2 hover:bg-opacity-80 cursor-pointer" style="background-color: var(--bg-primary);" onclick="selectSuggestion('${s}')">${s}</div>`
        ).join('');
        autocomplete.classList.remove('hidden');
    } else {
        autocomplete.classList.add('hidden');
    }
});

itemInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addItem();
    }
});

document.addEventListener('click', (e) => {
    if (!autocomplete.contains(e.target) && e.target !== itemInput) {
        autocomplete.classList.add('hidden');
    }
});

function selectSuggestion(text) {
    itemInput.value = text;
    autocomplete.classList.add('hidden');
    addItem();
}

let longPressTimer = null;
let longPressTriggered = false;

function setupItemEventListeners() {
    const itemsList = document.getElementById('items-list');
    
    itemsList.addEventListener('contextmenu', (e) => {
        const itemRow = e.target.closest('.item-row');
        if (itemRow) {
            e.preventDefault();
            const itemId = itemRow.getAttribute('data-item-id');
            const currentText = itemRow.getAttribute('data-item-text');
            editItem(itemId, currentText);
        }
    });
    
    itemsList.addEventListener('touchstart', (e) => {
        const itemRow = e.target.closest('.item-row');
        if (itemRow) {
            longPressTriggered = false;
            const itemId = itemRow.getAttribute('data-item-id');
            const currentText = itemRow.getAttribute('data-item-text');
            
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                navigator.vibrate && navigator.vibrate(50);
                editItem(itemId, currentText);
            }, 500);
        }
    }, { passive: true });
    
    itemsList.addEventListener('touchend', (e) => {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }, { passive: true });
    
    itemsList.addEventListener('touchmove', (e) => {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }, { passive: true });
}

let editingItemId = null;
let editingItemText = null;

function editItem(itemId, currentText) {
    editingItemId = itemId;
    editingItemText = currentText;
    
    const modal = document.getElementById('edit-item-modal');
    const input = document.getElementById('edit-item-input');
    
    input.value = currentText;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    
    setTimeout(() => {
        input.focus();
        input.select();
    }, 100);
}

function closeEditModal(event) {
    if (event && event.target.id !== 'edit-item-modal') {
        return;
    }
    
    const modal = document.getElementById('edit-item-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    
    editingItemId = null;
    editingItemText = null;
}

async function saveEditedItem() {
    const input = document.getElementById('edit-item-input');
    const newText = input.value.trim();
    
    if (!newText || newText === editingItemText) {
        closeEditModal();
        return;
    }
    
    const endpoint = (isEthereal && currentMode === 'edit')
        ? `/api/lists/${listId}/original/items/${editingItemId}`
        : `/api/lists/${listId}/items/${editingItemId}`;
    
    const response = await fetch(endpoint, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text: newText })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item updated successfully', 'success');
        
        const itemRow = document.querySelector(`[data-item-id="${editingItemId}"]`);
        const itemTextSpan = itemRow.querySelector('.item-text');
        itemTextSpan.textContent = newText;
        itemRow.setAttribute('data-item-text', newText);
        
        const itemsList = document.getElementById('items-list');
        const items = Array.from(itemsList.querySelectorAll('.item-row'));
        const updatedText = newText.toLowerCase();
        
        itemRow.remove();
        
        const insertIndex = items.findIndex(item => {
            if (item === itemRow) return false;
            const itemText = item.querySelector('.item-text').textContent;
            return itemText.toLowerCase() > updatedText;
        });
        
        if (insertIndex === -1) {
            itemsList.appendChild(itemRow);
        } else {
            itemsList.insertBefore(itemRow, items[insertIndex]);
        }
        
        closeEditModal();
    } else {
        showModal(`‚úó ${result.message}`, 'error');
    }
}

document.getElementById('edit-item-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        saveEditedItem();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const modal = document.getElementById('edit-item-modal');
        if (!modal.classList.contains('hidden')) {
            closeEditModal();
        }
    }
});

setupItemEventListeners();

async function addItem() {
    const text = itemInput.value.trim();
    if (!text) return;
    
    const endpoint = (isEthereal && currentMode === 'edit') 
        ? `/api/lists/${listId}/original/items`
        : `/api/lists/${listId}/items`;
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text })
    });
    
    const result = await response.json();
    
    if (result.success) {
        showModal('‚úì Item added successfully', 'success');
        itemInput.value = '';
        
        const itemsList = document.getElementById('items-list');
        const emptyMessage = itemsList.querySelector('p');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const newItemDiv = document.createElement('div');
        newItemDiv.className = 'flex items-center justify-between p-3 rounded item-row';
        newItemDiv.style.backgroundColor = 'var(--bg-primary)';
        newItemDiv.style.cursor = 'pointer';
        newItemDiv.setAttribute('data-item-id', result.item_id);
        newItemDiv.setAttribute('data-item-text', text);
        newItemDiv.setAttribute('data-checked', 'false');
        newItemDiv.setAttribute('data-quantity', '1');
        newItemDiv.setAttribute('onclick', `deleteItemByRow('${result.item_id}', event)`);
        
        const checkboxHidden = (!isEthereal || currentMode === 'edit') ? 'hidden' : '';
        const quantityHidden = isEthereal ? 'hidden' : '';
        
        newItemDiv.innerHTML = `
            <div class="flex items-center gap-3 flex-1">
                <input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer ${checkboxHidden}" 
                       onchange="toggleItemChecked('${result.item_id}')"
                       onclick="event.stopPropagation()">
                <span class="item-text">${text}</span>
            </div>
            ${isOwner || isCollaborator ? `<div class="flex items-center gap-2">
                <button class="quantity-btn ${quantityHidden} invisible text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${result.item_id}', -1, event)" data-action="decrease">
                    ‚àí
                </button>
                <button class="quantity-btn ${quantityHidden} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${result.item_id}', 1, event)" data-action="increase">
                    +
                </button>
            </div>` : ''}
        `;
        
        const items = Array.from(itemsList.querySelectorAll('.item-row'));
        const insertIndex = items.findIndex(item => {
            const itemText = item.querySelector('.item-text').textContent;
            return itemText.toLowerCase() > text.toLowerCase();
        });
        
        if (insertIndex === -1) {
            itemsList.appendChild(newItemDiv);
        } else {
            itemsList.insertBefore(newItemDiv, items[insertIndex]);
        }
        
        itemInput.focus();
    } else {
        showModal(`‚úó ${result.message}`, 'error');
        itemInput.focus();
    }
}

async function deleteItemByRow(itemId, event) {
    if (!isOwner && !isCollaborator) return;
    
    const target = event.target;
    if (target.classList.contains('quantity-btn') || target.classList.contains('item-checkbox')) {
        return;
    }
    
    const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
    const itemText = itemRow.getAttribute('data-item-text');
    
    const endpoint = (isEthereal && currentMode === 'edit')
        ? `/api/lists/${listId}/original/items/${itemId}`
        : `/api/lists/${listId}/items/${itemId}`;
    
    const response = await fetch(endpoint, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    if (response.ok) {
        undoStack.push({ id: itemId, text: itemText });
        if (undoStack.length > MAX_UNDO) {
            undoStack.shift();
        }
        updateUndoButton();
        
        itemRow.remove();
        
        if (document.querySelectorAll('[data-item-id]').length === 0) {
            document.getElementById('items-list').innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary);">No items yet. Start adding items above!</p>';
        }
    }
}

async function adjustQuantity(itemId, delta, event) {
    event.stopPropagation();
    
    const response = await fetch(`/api/lists/${listId}/items/${itemId}/quantity`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ delta })
    });
    
    if (response.ok) {
        const result = await response.json();
        const itemRow = document.querySelector(`[data-item-id="${itemId}"]`);
        itemRow.setAttribute('data-quantity', result.quantity);
        
        const itemTextSpan = itemRow.querySelector('.item-text');
        const existingQtySpan = itemTextSpan.nextElementSibling;
        if (existingQtySpan && existingQtySpan.textContent.startsWith('x')) {
            existingQtySpan.remove();
        }
        
        if (result.quantity > 1) {
            const qtySpan = document.createElement('span');
            qtySpan.className = 'text-sm';
            qtySpan.style.color = 'var(--text-secondary)';
            qtySpan.textContent = `x${result.quantity}`;
            itemTextSpan.parentNode.appendChild(qtySpan);
        }
        
        const decreaseBtn = itemRow.querySelector('[data-action="decrease"]');
        if (decreaseBtn) {
            if (result.quantity <= 1) {
                decreaseBtn.classList.add('invisible');
            } else {
                decreaseBtn.classList.remove('invisible');
            }
        }
    }
}

function updateUndoButton() {
    const undoBtn = document.getElementById('undo-btn');
    const undoCount = document.getElementById('undo-count');
    
    if (undoStack.length > 0) {
        undoBtn.classList.remove('hidden');
        undoCount.textContent = undoStack.length;
    } else {
        undoBtn.classList.add('hidden');
    }
}

async function undoDelete() {
    if (undoStack.length === 0) return;
    
    const item = undoStack.pop();
    
    // Check if item already exists in the list
    const existingItems = Array.from(document.querySelectorAll('.item-text'));
    const itemExists = existingItems.some(el => el.textContent.toLowerCase() === item.text.toLowerCase());
    
    if (itemExists) {
        showModal('‚úó Item already exists in the list', 'error');
        updateUndoButton();
        return;
    }
    
    updateUndoButton();
    
    const endpoint = (isEthereal && currentMode === 'edit') 
        ? `/api/lists/${listId}/original/items`
        : `/api/lists/${listId}/items`;
    
    const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ text: item.text })
    });
    
    if (response.ok) {
        const result = await response.json();
        
        const itemsList = document.getElementById('items-list');
        const emptyMessage = itemsList.querySelector('p');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const newItemDiv = document.createElement('div');
        newItemDiv.className = 'flex items-center justify-between p-3 rounded item-row';
        newItemDiv.style.backgroundColor = 'var(--bg-primary)';
        newItemDiv.style.cursor = 'pointer';
        newItemDiv.setAttribute('data-item-id', result.item_id);
        newItemDiv.setAttribute('data-item-text', item.text);
        newItemDiv.setAttribute('data-checked', 'false');
        newItemDiv.setAttribute('data-quantity', '1');
        newItemDiv.setAttribute('onclick', `deleteItemByRow('${result.item_id}', event)`);
        
        const checkboxHidden = (!isEthereal || currentMode === 'edit') ? 'hidden' : '';
        const quantityHidden = isEthereal ? 'hidden' : '';
        
        newItemDiv.innerHTML = `
            <div class="flex items-center gap-3 flex-1">
                <input type="checkbox" class="item-checkbox w-5 h-5 cursor-pointer ${checkboxHidden}" 
                       onchange="toggleItemChecked('${result.item_id}')"
                       onclick="event.stopPropagation()">
                <span class="item-text">${item.text}</span>
            </div>
            ${isOwner || isCollaborator ? `<div class="flex items-center gap-2">
                <button class="quantity-btn ${quantityHidden} invisible text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${result.item_id}', -1, event)" data-action="decrease">
                    ‚àí
                </button>
                <button class="quantity-btn ${quantityHidden} text-lg px-2 hover:opacity-70" onclick="adjustQuantity('${result.item_id}', 1, event)" data-action="increase">
                    +
                </button>
            </div>` : ''}
        `;
        
        const items = Array.from(itemsList.querySelectorAll('.item-row'));
        const undoneItemText = item.text.toLowerCase();
        const insertIndex = items.findIndex(existingItem => {
            const itemText = existingItem.querySelector('.item-text').textContent;
            return itemText.toLowerCase() > undoneItemText;
        });
        
        if (insertIndex === -1) {
            itemsList.appendChild(newItemDiv);
        } else {
            itemsList.insertBefore(newItemDiv, items[insertIndex]);
        }
    }
}

async function restoreList() {
    const isCheckOffMode = currentMode === 'checkOff';
    const confirmMessage = isCheckOffMode 
        ? 'Uncheck all items?' 
        : 'Restore list to original items? Current items will be replaced.';
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const response = await fetch(`/api/lists/${listId}/restore`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ reset_checked_only: isCheckOffMode })
    });
    
    const result = await response.json();
    
    if (result.success) {
        const message = isCheckOffMode ? '‚úì All items unchecked' : '‚úì List restored successfully';
        showModal(message, 'success');
        
        if (isCheckOffMode) {
            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.item-text').forEach(text => {
                text.classList.remove('line-through');
            });
            document.querySelectorAll('.item-row').forEach(row => {
                row.classList.remove('opacity-50');
            });
        } else {
            setTimeout(() => location.reload(), 1000);
        }
    } else {
        showModal('‚úó Failed to restore list', 'error');
    }
}
{% endif %}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this list? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}

{% if not is_owner %}
async function toggleFavorite() {
    const response = await fetch(`/api/favorite/${listId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        }
    });
    
    const result = await response.json();
    
    if (result.success) {
        const btn = document.getElementById('favorite-btn');
        const icon = document.getElementById('favorite-icon');
        const text = document.getElementById('favorite-text');
        
        if (result.favorited) {
            btn.classList.remove('card');
            btn.classList.add('bg-yellow-600');
            icon.textContent = '‚≠ê';
            text.textContent = 'Favorited';
        } else {
            btn.classList.add('card');
            btn.classList.remove('bg-yellow-600');
            icon.textContent = '‚òÜ';
            text.textContent = 'Favorite';
        }
    }
}
{% endif %}

function showModal(message, type) {
    const notification = document.getElementById('inline-notification');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    notification.className = `w-full mt-2 p-3 rounded text-white text-center ${bgColor}`;
    notification.textContent = message;
    notification.classList.remove('hidden');
    
    const duration = type === 'success' ? 2000 : 3000;
    setTimeout(() => {
        notification.classList.add('hidden');
    }, duration);
}
</script>
{% endblock %}
